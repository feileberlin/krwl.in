name: ðŸ“„ Generate HTML

on:
  push:
    branches:
      - main
      - preview
  workflow_dispatch:
    inputs:
      force_regenerate_demo:
        description: 'Force regenerate demo events (even on main branch)'
        required: false
        type: boolean
        default: false
      target_branch:
        description: 'Target branch (production/preview override)'
        required: false
        type: choice
        options:
          - auto
          - production
          - preview
        default: auto

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Download Leaflet library
        run: ./download-libs.sh

      - name: Determine mode
        id: determine_mode
        run: |
          # Determine mode based on input or branch
          if [ "${{ inputs.target_branch }}" == "production" ]; then
            MODE="production"
          elif [ "${{ inputs.target_branch }}" == "preview" ]; then
            MODE="preview"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            MODE="production"
          else
            MODE="preview"
          fi
          echo "MODE=$MODE" >> $GITHUB_ENV
          echo "mode=$MODE" >> $GITHUB_OUTPUT
          echo "ðŸŽ¯ Mode: $MODE"

      - name: Generate fresh demo events
        if: |
          env.MODE == 'preview' || 
          inputs.force_regenerate_demo == true
        run: |
          echo "ðŸŽ­ Regenerating demo events with current timestamps..."
          python3 scripts/generate_demo_events.py > static/events.demo.json
          
          # Show summary
          EVENT_COUNT=$(python3 -c "import json; print(len(json.load(open('static/events.demo.json'))['events']))")
          echo "âœ“ Generated $EVENT_COUNT demo events"

      - name: Generate HTML
        run: |
          if [ "$MODE" == "production" ]; then
            python3 scripts/generate_html.py production
            FILE="static/index.html"
          else
            python3 scripts/generate_html.py preview
            FILE="static/preview/index.html"
          fi
          echo "FILE=$FILE" >> $GITHUB_ENV
          echo "ðŸ”¨ Generated $FILE"

      - name: Commit generated files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add files based on mode and whether demo events were regenerated
          if [ "$MODE" == "preview" ]; then
            git add static/preview/index.html static/events.demo.json
            COMMIT_MSG="Generate preview HTML"
            if [ "${{ inputs.force_regenerate_demo }}" == "true" ]; then
              COMMIT_MSG="$COMMIT_MSG with fresh demo events"
            fi
          else
            git add static/index.html
            COMMIT_MSG="Generate production HTML"
            if [ "${{ inputs.force_regenerate_demo }}" == "true" ]; then
              git add static/events.demo.json
              COMMIT_MSG="$COMMIT_MSG with fresh demo events"
            fi
          fi
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit"
          else
            git commit -m "$COMMIT_MSG [skip ci]"
            git push
            echo ""
            echo "âœ… Successfully generated $FILE!"
            if [ "$MODE" == "preview" ]; then
              echo ""
              echo "ðŸ“¥ Download and open:"
              echo "  https://github.com/${{ github.repository }}/raw/${{ github.ref_name }}/static/preview/index.html"
            else
              echo ""
              echo "ðŸš€ Deployed at https://krwl.in/"
            fi
          fi

      - name: Summary
        if: always()
        run: |
          echo "## HTML Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Mode:** $MODE" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "$FILE" ]; then
            SIZE=$(du -h "$FILE" | cut -f1)
            echo "âœ… **Generated:** $FILE ($SIZE)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "static/events.demo.json" ]; then
            EVENT_COUNT=$(python3 -c "import json; print(len(json.load(open('static/events.demo.json'))['events']))" 2>/dev/null || echo "?")
            if [ "$MODE" == "preview" ] || [ "${{ inputs.force_regenerate_demo }}" == "true" ]; then
              echo "âœ… **Demo events:** $EVENT_COUNT events (regenerated)" >> $GITHUB_STEP_SUMMARY
            fi
          fi
