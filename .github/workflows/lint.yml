name: üîç Lint Code Quality

on:
  push:
    branches:
      - preview
      - main
  pull_request:
    branches:
      - preview
      - main
  workflow_dispatch:
    inputs:
      fail_on_python_errors:
        description: 'üêç Block on Python critical errors'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      fail_on_js_errors:
        description: 'üìú Block on JavaScript errors'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      fail_on_json_errors:
        description: 'üìã Block on JSON validation errors'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      fail_on_style_issues:
        description: '‚ú® Block on style/warning issues'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

# Lint Policy Configuration
# Customize enforcement levels for your project
env:
  # Critical errors (syntax errors, undefined variables, etc.)
  FAIL_ON_PYTHON_CRITICAL: 'true'    # Block PRs with Python critical errors
  FAIL_ON_JSON_INVALID: 'true'       # Block PRs with invalid JSON
  
  # Code quality issues (warnings, style, complexity)
  FAIL_ON_PYTHON_STYLE: 'false'      # Warn only on Python style issues
  FAIL_ON_JS_ERRORS: 'false'         # Warn only on JavaScript issues
  
  # Thresholds (only used if above is 'true')
  MAX_PYTHON_ERRORS: 0               # Maximum critical errors allowed
  MAX_JS_ERRORS: 5                   # Maximum JS errors allowed
  MAX_PYTHON_STYLE_ISSUES: 50        # Maximum style issues allowed

permissions:
  contents: read
  pull-requests: write

jobs:
  lint:
    runs-on: ubuntu-latest
    name: Lint Python, JavaScript, and JSON
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install Python linters
        run: |
          pip install --upgrade pip
          pip install pylint flake8 black pycodestyle
          echo "‚úì Installed Python linters: pylint, flake8, black"
      
      - name: Install JavaScript linters
        run: |
          npm install -g eslint jshint
          echo "‚úì Installed JavaScript linters: eslint, jshint"
      
      - name: Install JSON validator
        run: |
          npm install -g jsonlint
          echo "‚úì Installed JSON validator: jsonlint"
      
      - name: Lint Python files
        id: python_lint
        continue-on-error: true
        run: |
          echo "=========================================="
          echo "Linting Python Files"
          echo "=========================================="
          
          # Find all Python files
          PYTHON_FILES=$(find . -name "*.py" ! -path "./.git/*" ! -path "./venv/*" ! -path "./__pycache__/*")
          
          if [ -z "$PYTHON_FILES" ]; then
            echo "No Python files found"
            exit 0
          fi
          
          echo "Files to check:"
          echo "$PYTHON_FILES"
          echo ""
          
          # Run flake8 (more lenient, focuses on errors)
          echo "Running flake8..."
          flake8 $PYTHON_FILES \
            --max-line-length=100 \
            --ignore=E203,E266,E501,W503,F403,F401 \
            --max-complexity=15 \
            --show-source \
            --statistics > flake8_report.txt 2>&1 || true
          
          cat flake8_report.txt
          
          # Check for critical errors only
          CRITICAL_ERRORS=$(grep -E "E9|F63|F7|F82" flake8_report.txt | wc -l)
          
          if [ $CRITICAL_ERRORS -gt 0 ]; then
            echo "‚ùå Found $CRITICAL_ERRORS critical Python errors"
            echo "python_status=failed" >> $GITHUB_OUTPUT
            echo "python_critical=$CRITICAL_ERRORS" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ No critical Python errors found"
            echo "python_status=passed" >> $GITHUB_OUTPUT
            echo "python_critical=0" >> $GITHUB_OUTPUT
          fi
          
          # Count total issues (for information)
          TOTAL_ISSUES=$(grep -c ":" flake8_report.txt 2>/dev/null || echo "0")
          echo "python_total=$TOTAL_ISSUES" >> $GITHUB_OUTPUT
          echo "Total Python style issues (non-critical): $TOTAL_ISSUES"
      
      - name: Lint JavaScript files
        id: js_lint
        continue-on-error: true
        run: |
          echo ""
          echo "=========================================="
          echo "Linting JavaScript Files"
          echo "=========================================="
          
          # Find all JavaScript files
          JS_FILES=$(find . -name "*.js" ! -path "./.git/*" ! -path "./node_modules/*")
          
          if [ -z "$JS_FILES" ]; then
            echo "No JavaScript files found"
            echo "js_status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Files to check:"
          echo "$JS_FILES"
          echo ""
          
          # Create a simple .jshintrc for vanilla JS
          cat > .jshintrc << 'EOF'
{
  "esversion": 6,
  "browser": true,
  "devel": true,
  "strict": false,
  "unused": false,
  "undef": true,
  "predef": ["L", "fetch"],
  "maxcomplexity": 15,
  "maxdepth": 4,
  "maxstatements": 50,
  "maxlen": 120
}
EOF
          
          # Run jshint
          echo "Running jshint..."
          jshint $JS_FILES > jshint_report.txt 2>&1 || true
          
          cat jshint_report.txt
          
          # Check for errors
          if grep -q "error" jshint_report.txt 2>/dev/null; then
            JS_ERRORS=$(grep -c "error" jshint_report.txt)
            echo "‚ö†Ô∏è  Found $JS_ERRORS JavaScript issues"
            echo "js_status=warnings" >> $GITHUB_OUTPUT
            echo "js_errors=$JS_ERRORS" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ No JavaScript errors found"
            echo "js_status=passed" >> $GITHUB_OUTPUT
            echo "js_errors=0" >> $GITHUB_OUTPUT
          fi
      
      - name: Validate JSON files
        id: json_lint
        continue-on-error: true
        run: |
          echo ""
          echo "=========================================="
          echo "Validating JSON Files"
          echo "=========================================="
          
          # Find all JSON files
          JSON_FILES=$(find . -name "*.json" ! -path "./.git/*" ! -path "./node_modules/*" ! -path "./package-lock.json")
          
          if [ -z "$JSON_FILES" ]; then
            echo "No JSON files found"
            echo "json_status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Files to check:"
          echo "$JSON_FILES"
          echo ""
          
          INVALID_JSON=0
          INVALID_FILES=""
          
          # Check each JSON file
          for file in $JSON_FILES; do
            echo "Checking $file..."
            if ! jsonlint -q "$file" 2>/dev/null; then
              echo "‚ùå Invalid JSON: $file"
              INVALID_JSON=$((INVALID_JSON + 1))
              INVALID_FILES="$INVALID_FILES\n  - $file"
            else
              echo "‚úÖ Valid: $file"
            fi
          done
          
          echo ""
          if [ $INVALID_JSON -gt 0 ]; then
            echo "‚ùå Found $INVALID_JSON invalid JSON files"
            echo "json_status=failed" >> $GITHUB_OUTPUT
            echo "json_errors=$INVALID_JSON" >> $GITHUB_OUTPUT
            echo "json_files<<EOF" >> $GITHUB_OUTPUT
            echo -e "$INVALID_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ All JSON files are valid"
            echo "json_status=passed" >> $GITHUB_OUTPUT
            echo "json_errors=0" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload lint reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: lint-reports
          path: |
            flake8_report.txt
            jshint_report.txt
            .jshintrc
      
      - name: Comment on PR with lint results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // Gather results
            const pythonStatus = '${{ steps.python_lint.outputs.python_status }}';
            const pythonCritical = '${{ steps.python_lint.outputs.python_critical }}' || '0';
            const pythonTotal = '${{ steps.python_lint.outputs.python_total }}' || '0';
            
            const jsStatus = '${{ steps.js_lint.outputs.js_status }}';
            const jsErrors = '${{ steps.js_lint.outputs.js_errors }}' || '0';
            
            const jsonStatus = '${{ steps.json_lint.outputs.json_status }}';
            const jsonErrors = '${{ steps.json_lint.outputs.json_errors }}' || '0';
            
            // Build comment
            let commentBody = '## üîç Lint Results\n\n';
            
            // Python
            commentBody += '### üêç Python\n';
            if (pythonStatus === 'passed') {
              commentBody += '‚úÖ **Passed** - No critical errors\n';
              if (pythonTotal > 0) {
                commentBody += `‚ÑπÔ∏è  ${pythonTotal} style suggestions (non-critical)\n`;
              }
            } else if (pythonStatus === 'failed') {
              commentBody += `‚ùå **Failed** - ${pythonCritical} critical errors found\n`;
              commentBody += '```\nSee flake8_report.txt in artifacts for details\n```\n';
            }
            commentBody += '\n';
            
            // JavaScript
            commentBody += '### üìú JavaScript\n';
            if (jsStatus === 'passed') {
              commentBody += '‚úÖ **Passed** - No errors\n';
            } else if (jsStatus === 'warnings') {
              commentBody += `‚ö†Ô∏è  **Warnings** - ${jsErrors} issues found\n`;
              commentBody += '```\nSee jshint_report.txt in artifacts for details\n```\n';
            } else if (jsStatus === 'skipped') {
              commentBody += '‚ÑπÔ∏è  No JavaScript files to check\n';
            }
            commentBody += '\n';
            
            // JSON
            commentBody += '### üìã JSON\n';
            if (jsonStatus === 'passed') {
              commentBody += '‚úÖ **Passed** - All JSON files are valid\n';
            } else if (jsonStatus === 'failed') {
              commentBody += `‚ùå **Failed** - ${jsonErrors} invalid JSON files\n`;
              const invalidFiles = '${{ steps.json_lint.outputs.json_files }}';
              if (invalidFiles) {
                commentBody += '```\n' + invalidFiles + '\n```\n';
              }
            } else if (jsonStatus === 'skipped') {
              commentBody += '‚ÑπÔ∏è  No JSON files to check\n';
            }
            commentBody += '\n';
            
            // Summary and recommendations
            const hasCriticalIssues = pythonStatus === 'failed' || jsonStatus === 'failed';
            const hasWarnings = jsStatus === 'warnings' || (pythonTotal > 0 && pythonStatus === 'passed');
            
            if (hasCriticalIssues) {
              commentBody += '### ‚ö†Ô∏è Action Required\n\n';
              commentBody += 'Critical issues found. Please fix before merging:\n\n';
              if (pythonStatus === 'failed') {
                commentBody += '- Fix Python critical errors\n';
              }
              if (jsonStatus === 'failed') {
                commentBody += '- Fix invalid JSON files\n';
              }
            } else if (hasWarnings) {
              commentBody += '### üí° Suggestions\n\n';
              commentBody += 'Code is functional but could be improved:\n\n';
              if (pythonTotal > 0) {
                commentBody += `- Consider addressing ${pythonTotal} Python style suggestions\n`;
              }
              if (jsStatus === 'warnings') {
                commentBody += `- Review ${jsErrors} JavaScript warnings\n`;
              }
              commentBody += '\nThese are recommendations, not blockers.\n';
            } else {
              commentBody += '### üéâ Excellent!\n\n';
              commentBody += 'All linting checks passed with flying colors!\n';
            }
            
            commentBody += '\n---\n';
            commentBody += '**Run locally:**\n';
            commentBody += '```bash\n';
            commentBody += '# Python\n';
            commentBody += 'flake8 src/ --max-line-length=100 --ignore=E203,E501\n\n';
            commentBody += '# JavaScript\n';
            commentBody += 'jshint static/js/app.js\n\n';
            commentBody += '# JSON\n';
            commentBody += 'jsonlint features.json\n';
            commentBody += '```\n';
            
            // Find and update or create comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('üîç Lint Results')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              });
            }
      
      - name: Create job summary
        if: always()
        run: |
          echo "## üîç Lint Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Python
          echo "### üêç Python" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.python_lint.outputs.python_status }}" == "passed" ]; then
            echo "‚úÖ Passed (Critical errors: 0)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Failed (Critical errors: ${{ steps.python_lint.outputs.python_critical }})" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # JavaScript
          echo "### üìú JavaScript" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.js_lint.outputs.js_status }}" == "passed" ]; then
            echo "‚úÖ Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.js_lint.outputs.js_status }}" == "warnings" ]; then
            echo "‚ö†Ô∏è  Warnings: ${{ steps.js_lint.outputs.js_errors }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # JSON
          echo "### üìã JSON" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.json_lint.outputs.json_status }}" == "passed" ]; then
            echo "‚úÖ All valid" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.json_lint.outputs.json_status }}" == "failed" ]; then
            echo "‚ùå Invalid files: ${{ steps.json_lint.outputs.json_errors }}" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Evaluate lint policy
        if: always()
        id: policy
        run: |
          echo "=========================================="
          echo "Evaluating Lint Policy"
          echo "=========================================="
          
          # Get configuration (with workflow dispatch overrides)
          FAIL_ON_PYTHON_CRITICAL="${{ env.FAIL_ON_PYTHON_CRITICAL }}"
          FAIL_ON_JSON_INVALID="${{ env.FAIL_ON_JSON_INVALID }}"
          FAIL_ON_PYTHON_STYLE="${{ env.FAIL_ON_PYTHON_STYLE }}"
          FAIL_ON_JS_ERRORS="${{ env.FAIL_ON_JS_ERRORS }}"
          
          # Override with workflow dispatch inputs if provided
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            [ -n "${{ github.event.inputs.fail_on_python_errors }}" ] && FAIL_ON_PYTHON_CRITICAL="${{ github.event.inputs.fail_on_python_errors }}"
            [ -n "${{ github.event.inputs.fail_on_js_errors }}" ] && FAIL_ON_JS_ERRORS="${{ github.event.inputs.fail_on_js_errors }}"
            [ -n "${{ github.event.inputs.fail_on_json_errors }}" ] && FAIL_ON_JSON_INVALID="${{ github.event.inputs.fail_on_json_errors }}"
            [ -n "${{ github.event.inputs.fail_on_style_issues }}" ] && FAIL_ON_PYTHON_STYLE="${{ github.event.inputs.fail_on_style_issues }}"
          fi
          
          # Get results
          PYTHON_STATUS="${{ steps.python_lint.outputs.python_status }}"
          PYTHON_CRITICAL="${{ steps.python_lint.outputs.python_critical }}"
          PYTHON_TOTAL="${{ steps.python_lint.outputs.python_total }}"
          JS_STATUS="${{ steps.js_lint.outputs.js_status }}"
          JS_ERRORS="${{ steps.js_lint.outputs.js_errors }}"
          JSON_STATUS="${{ steps.json_lint.outputs.json_status }}"
          JSON_ERRORS="${{ steps.json_lint.outputs.json_errors }}"
          
          # Determine if we should fail
          SHOULD_FAIL="false"
          FAIL_REASONS=""
          
          # Check Python critical errors
          if [ "$FAIL_ON_PYTHON_CRITICAL" == "true" ] && [ "$PYTHON_STATUS" == "failed" ]; then
            if [ "${PYTHON_CRITICAL:-0}" -gt "${{ env.MAX_PYTHON_ERRORS }}" ]; then
              SHOULD_FAIL="true"
              FAIL_REASONS="${FAIL_REASONS}- Python critical errors: ${PYTHON_CRITICAL} (max: ${{ env.MAX_PYTHON_ERRORS }})\n"
              echo "‚ùå Policy violation: Python critical errors"
            fi
          fi
          
          # Check Python style issues
          if [ "$FAIL_ON_PYTHON_STYLE" == "true" ] && [ "${PYTHON_TOTAL:-0}" -gt "${{ env.MAX_PYTHON_STYLE_ISSUES }}" ]; then
            SHOULD_FAIL="true"
            FAIL_REASONS="${FAIL_REASONS}- Python style issues: ${PYTHON_TOTAL} (max: ${{ env.MAX_PYTHON_STYLE_ISSUES }})\n"
            echo "‚ùå Policy violation: Too many Python style issues"
          fi
          
          # Check JavaScript errors
          if [ "$FAIL_ON_JS_ERRORS" == "true" ] && [ "$JS_STATUS" == "warnings" ]; then
            if [ "${JS_ERRORS:-0}" -gt "${{ env.MAX_JS_ERRORS }}" ]; then
              SHOULD_FAIL="true"
              FAIL_REASONS="${FAIL_REASONS}- JavaScript errors: ${JS_ERRORS} (max: ${{ env.MAX_JS_ERRORS }})\n"
              echo "‚ùå Policy violation: Too many JavaScript errors"
            fi
          fi
          
          # Check JSON validity
          if [ "$FAIL_ON_JSON_INVALID" == "true" ] && [ "$JSON_STATUS" == "failed" ]; then
            SHOULD_FAIL="true"
            FAIL_REASONS="${FAIL_REASONS}- Invalid JSON files: ${JSON_ERRORS}\n"
            echo "‚ùå Policy violation: Invalid JSON files"
          fi
          
          # Output results
          echo "should_fail=$SHOULD_FAIL" >> $GITHUB_OUTPUT
          echo "fail_reasons<<EOF" >> $GITHUB_OUTPUT
          echo -e "$FAIL_REASONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo ""
          echo "Policy Configuration:"
          echo "  Python Critical: $FAIL_ON_PYTHON_CRITICAL"
          echo "  Python Style: $FAIL_ON_PYTHON_STYLE"
          echo "  JavaScript: $FAIL_ON_JS_ERRORS"
          echo "  JSON: $FAIL_ON_JSON_INVALID"
          echo ""
          
          if [ "$SHOULD_FAIL" == "true" ]; then
            echo "üö´ Policy decision: BLOCK PR"
            echo -e "Reasons:\n$FAIL_REASONS"
          else
            echo "‚úÖ Policy decision: ALLOW PR (warnings only)"
          fi
          echo "=========================================="
      
      - name: Add policy labels to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        continue-on-error: true
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const shouldFail = '${{ steps.policy.outputs.should_fail }}' === 'true';
            const pythonStatus = '${{ steps.python_lint.outputs.python_status }}';
            const jsStatus = '${{ steps.js_lint.outputs.js_status }}';
            const jsonStatus = '${{ steps.json_lint.outputs.json_status }}';
            
            const labels = [];
            
            // Add status labels
            if (shouldFail) {
              labels.push('lint: needs-fixes');
            } else if (pythonStatus === 'passed' && jsStatus === 'passed' && jsonStatus === 'passed') {
              labels.push('lint: clean');
            } else {
              labels.push('lint: has-warnings');
            }
            
            // Add specific issue labels
            if (pythonStatus === 'failed') {
              labels.push('python: critical-errors');
            } else if (parseInt('${{ steps.python_lint.outputs.python_total }}') > 0) {
              labels.push('python: style-suggestions');
            }
            
            if (jsStatus === 'warnings') {
              labels.push('javascript: warnings');
            }
            
            if (jsonStatus === 'failed') {
              labels.push('json: invalid');
            }
            
            if (labels.length > 0) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: labels
                });
                console.log(`Added labels: ${labels.join(', ')}`);
              } catch (error) {
                console.log('Note: Some labels may not exist. Create them in repository settings.');
                console.log('Suggested labels:', labels.join(', '));
              }
            }
      
      - name: Update PR comment with policy decision
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const shouldFail = '${{ steps.policy.outputs.should_fail }}' === 'true';
            const failReasons = `${{ steps.policy.outputs.fail_reasons }}`;
            
            // Gather results
            const pythonStatus = '${{ steps.python_lint.outputs.python_status }}';
            const pythonCritical = '${{ steps.python_lint.outputs.python_critical }}' || '0';
            const pythonTotal = '${{ steps.python_lint.outputs.python_total }}' || '0';
            
            const jsStatus = '${{ steps.js_lint.outputs.js_status }}';
            const jsErrors = '${{ steps.js_lint.outputs.js_errors }}' || '0';
            
            const jsonStatus = '${{ steps.json_lint.outputs.json_status }}';
            const jsonErrors = '${{ steps.json_lint.outputs.json_errors }}' || '0';
            
            // Build comment
            let commentBody = '';
            
            // Policy header
            if (shouldFail) {
              commentBody += '## üö´ Lint Check: BLOCKED\n\n';
              commentBody += '> **This PR cannot be merged until the following issues are fixed:**\n\n';
              commentBody += failReasons;
              commentBody += '\n';
            } else {
              commentBody += '## üîç Lint Results\n\n';
              const hasIssues = pythonStatus === 'failed' || jsStatus === 'warnings' || jsonStatus === 'failed';
              if (hasIssues) {
                commentBody += '> ‚ÑπÔ∏è  Issues found, but PR can be merged. Consider fixing for better code quality.\n\n';
              } else {
                commentBody += '> ‚úÖ All checks passed!\n\n';
              }
            }
            
            // Python
            commentBody += '### üêç Python\n';
            if (pythonStatus === 'passed') {
              commentBody += '‚úÖ **Passed** - No critical errors\n';
              if (pythonTotal > 0) {
                commentBody += `‚ÑπÔ∏è  ${pythonTotal} style suggestions (non-critical)\n`;
              }
            } else if (pythonStatus === 'failed') {
              commentBody += `‚ùå **Failed** - ${pythonCritical} critical errors found\n`;
              if (shouldFail && failReasons.includes('Python critical')) {
                commentBody += '**‚ö†Ô∏è  Must be fixed before merge**\n';
              }
              commentBody += '\n<details><summary>View details</summary>\n\n```\nSee flake8_report.txt in artifacts\n```\n</details>\n';
            }
            commentBody += '\n';
            
            // JavaScript
            commentBody += '### üìú JavaScript\n';
            if (jsStatus === 'passed') {
              commentBody += '‚úÖ **Passed** - No errors\n';
            } else if (jsStatus === 'warnings') {
              commentBody += `‚ö†Ô∏è  **Warnings** - ${jsErrors} issues found\n`;
              if (shouldFail && failReasons.includes('JavaScript')) {
                commentBody += '**‚ö†Ô∏è  Must be fixed before merge**\n';
              }
              commentBody += '\n<details><summary>View details</summary>\n\n```\nSee jshint_report.txt in artifacts\n```\n</details>\n';
            } else if (jsStatus === 'skipped') {
              commentBody += '‚ÑπÔ∏è  No JavaScript files to check\n';
            }
            commentBody += '\n';
            
            // JSON
            commentBody += '### üìã JSON\n';
            if (jsonStatus === 'passed') {
              commentBody += '‚úÖ **Passed** - All JSON files are valid\n';
            } else if (jsonStatus === 'failed') {
              commentBody += `‚ùå **Failed** - ${jsonErrors} invalid JSON files\n`;
              if (shouldFail && failReasons.includes('JSON')) {
                commentBody += '**‚ö†Ô∏è  Must be fixed before merge**\n';
              }
              const invalidFiles = '${{ steps.json_lint.outputs.json_files }}';
              if (invalidFiles) {
                commentBody += '\n<details><summary>Invalid files</summary>\n\n```\n' + invalidFiles + '\n```\n</details>\n';
              }
            } else if (jsonStatus === 'skipped') {
              commentBody += '‚ÑπÔ∏è  No JSON files to check\n';
            }
            commentBody += '\n';
            
            // Policy info
            commentBody += '<details><summary>üìã Lint Policy Configuration</summary>\n\n';
            commentBody += '**Current Settings:**\n';
            commentBody += `- Python Critical Errors: ${shouldFail && failReasons.includes('Python critical') ? 'üö´ Block' : '‚úÖ Allow'}\n`;
            commentBody += `- Python Style Issues: ${shouldFail && failReasons.includes('Python style') ? 'üö´ Block' : '‚úÖ Warn only'}\n`;
            commentBody += `- JavaScript Errors: ${shouldFail && failReasons.includes('JavaScript') ? 'üö´ Block' : '‚úÖ Warn only'}\n`;
            commentBody += `- JSON Validation: ${shouldFail && failReasons.includes('JSON') ? 'üö´ Block' : '‚úÖ Allow'}\n\n`;
            commentBody += '**To change policy:** Edit `.github/workflows/lint.yml` (env section)\n';
            commentBody += '</details>\n\n';
            
            commentBody += '---\n';
            commentBody += '**Run locally:**\n';
            commentBody += '```bash\n';
            commentBody += '# Python\n';
            commentBody += 'flake8 src/ --max-line-length=100 --ignore=E203,E501\n\n';
            commentBody += '# JavaScript\n';
            commentBody += 'jshint static/js/app.js\n\n';
            commentBody += '# JSON\n';
            commentBody += 'jsonlint features.json\n';
            commentBody += '```\n';
            
            // Find and update or create comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('üîç Lint Results')
            ) || comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('Lint Check: BLOCKED')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              });
            }
      
      - name: Fail on critical errors (based on policy)
        if: steps.policy.outputs.should_fail == 'true'
        run: |
          echo "=========================================="
          echo "‚ùå LINT CHECK FAILED - POLICY VIOLATION"
          echo "=========================================="
          echo ""
          echo "The following issues must be fixed:"
          echo ""
          echo -e "${{ steps.policy.outputs.fail_reasons }}"
          echo ""
          echo "üìã Current Policy:"
          echo "  - Blocks merges for configured error types"
          echo "  - See workflow logs for detailed reports"
          echo "  - Download artifacts for full lint output"
          echo ""
          echo "üí° To change policy:"
          echo "  Edit .github/workflows/lint.yml (env section)"
          echo ""
          echo "=========================================="
          
          exit 1
      
      - name: Success message
        if: steps.policy.outputs.should_fail != 'true'
        run: |
          echo "‚úÖ Lint checks passed (or warnings only)!"
          
          if [ "${{ steps.js_lint.outputs.js_status }}" == "warnings" ]; then
            echo "üí° JavaScript has some warnings - consider reviewing them"
          fi
          
          if [ "${{ steps.python_lint.outputs.python_total }}" != "0" ]; then
            echo "üí° Python has ${{ steps.python_lint.outputs.python_total }} style suggestions - non-critical"
          fi
          
          echo ""
          echo "Policy allows this PR to be merged."
          echo "Consider addressing warnings for better code quality."
