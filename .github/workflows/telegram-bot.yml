name: ü§ñ Telegram Bot - Event Submissions & Contact Form [DEPRECATED]

# ‚ö†Ô∏è DEPRECATED: This workflow uses the old conversation-based bot.
# Use the new simplified approach integrated into website-maintenance.yml instead.
# See docs/TELEGRAM_INTEGRATION.md for migration guide.

# Phase 2 Backend Integration: GitHub Actions workflow to proxy Telegram bot submissions
# - Uses TELEGRAM_BOT_TOKEN secret from GitHub Secrets
# - Forwards contact messages to admin Telegram chat (config.telegram.admin_chat_ids)
# - Saves flyer uploads to pending_events.json via Telegram Bot API
# - Leverages existing telegram_bot.py infrastructure

on:
  workflow_dispatch:
    inputs:
      duration_minutes:
        description: '‚è±Ô∏è Bot run duration in minutes (1-60)'
        required: false
        type: number
        default: 10
      
      mode:
        description: 'üéØ Bot operation mode'
        required: true
        type: choice
        options:
          - 'polling'      # Run bot with long polling (default)
          - 'webhook'      # Set up webhook (future implementation)
          - 'stop'         # Stop bot gracefully
        default: 'polling'
  
  schedule:
    # Run bot every 15 minutes during active hours (UTC)
    # 05:00-21:45 UTC = 06:00-22:45 CET
    - cron: '*/15 5-21 * * *'  # Every 15 min, 6 AM - 10:45 PM CET

permissions:
  contents: write  # Allow pushing pending_events.json updates

# Prevent concurrent bot instances
concurrency:
  group: "telegram-bot"
  cancel-in-progress: true

jobs:
  run-telegram-bot:
    name: ü§ñ Run Telegram Bot
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Maximum 60 minutes per run
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          cache: 'pip'
      
      - name: üì¶ Install dependencies
        run: |
          pip install -r requirements.txt
          echo "‚úÖ Installed dependencies"
      
      - name: üîë Configure bot token
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ]; then
            echo "‚ùå ERROR: TELEGRAM_BOT_TOKEN secret not configured"
            echo "Please add TELEGRAM_BOT_TOKEN to repository secrets:"
            echo "1. Go to Settings > Secrets and variables > Actions"
            echo "2. Click 'New repository secret'"
            echo "3. Name: TELEGRAM_BOT_TOKEN"
            echo "4. Value: Your bot token from @BotFather"
            exit 1
          fi
          
          echo "‚úÖ Bot token configured"
          echo "TELEGRAM_BOT_TOKEN is set (length: ${#TELEGRAM_BOT_TOKEN})"
      
      - name: ü§ñ Run Telegram bot
        id: run_bot
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          set -e
          
          # Calculate run duration
          DURATION=${{ inputs.duration_minutes || 10 }}
          MODE="${{ inputs.mode || 'polling' }}"
          
          echo "üöÄ Starting Telegram bot..."
          echo "Mode: $MODE"
          echo "Duration: $DURATION minutes"
          
          if [ "$MODE" = "stop" ]; then
            echo "üõë Stop mode - exiting gracefully"
            exit 0
          fi
          
          if [ "$MODE" = "webhook" ]; then
            echo "‚ö†Ô∏è  Webhook mode not yet implemented"
            echo "Using polling mode instead"
          fi
          
          # Run bot with timeout
          # The bot will run for specified duration then exit gracefully
          timeout --signal=SIGINT ${DURATION}m python3 src/event_manager.py telegram-bot || {
            EXIT_CODE=$?
            if [ $EXIT_CODE -eq 124 ]; then
              echo "‚úÖ Bot stopped after ${DURATION} minutes (normal timeout)"
            elif [ $EXIT_CODE -eq 130 ]; then
              echo "‚úÖ Bot stopped gracefully (SIGINT)"
            else
              echo "‚ùå Bot exited with code $EXIT_CODE"
              exit $EXIT_CODE
            fi
          }
          
          echo "BOT_RAN=true" >> $GITHUB_OUTPUT
      
      - name: üìä Check for new submissions
        id: check_changes
        run: |
          set -e
          
          # Check if pending_events.json was modified
          if git diff --quiet assets/json/pending_events.json; then
            echo "No new submissions"
            echo "CHANGES_DETECTED=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ New submissions detected!"
            echo "CHANGES_DETECTED=true" >> $GITHUB_OUTPUT
            
            # Show what changed
            echo "Changes in pending_events.json:"
            git diff --stat assets/json/pending_events.json || true
          fi
      
      - name: üíæ Commit new submissions
        if: steps.check_changes.outputs.CHANGES_DETECTED == 'true'
        run: |
          set -e
          
          # Configure git
          git config user.name "Telegram Bot"
          git config user.email "telegram-bot@krwl-hof.github.io"
          
          # Commit changes
          git add assets/json/pending_events.json
          
          # Count new events (rough estimate)
          NEW_EVENTS=$(git diff --cached assets/json/pending_events.json | grep -c '^\+.*"id":' || echo "0")
          
          # Create commit message
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          git commit -m "ü§ñ Telegram bot: Added $NEW_EVENTS new event(s) to pending review [skip ci]" \
                     -m "Source: Telegram Bot API" \
                     -m "Timestamp: $TIMESTAMP" || {
            echo "No changes to commit"
          }
          
          # Push changes
          git push origin ${{ github.ref_name }} || {
            echo "‚ö†Ô∏è  Failed to push changes - may need to pull first"
            git pull --rebase origin ${{ github.ref_name }}
            git push origin ${{ github.ref_name }}
          }
          
          echo "‚úÖ Pushed new submissions to repository"
      
      - name: üìà Report statistics
        if: always()
        run: |
          echo "=== Telegram Bot Statistics ==="
          
          # Count pending events
          PENDING_COUNT=$(python3 -c "
          import json
          from pathlib import Path
          
          pending_file = Path('assets/json/pending_events.json')
          if pending_file.exists():
              data = json.loads(pending_file.read_text())
              print(len(data.get('pending_events', [])))
          else:
              print('0')
          " || echo "0")
          
          echo "üìä Pending events: $PENDING_COUNT"
          echo "ü§ñ Bot run: ${{ steps.run_bot.outputs.BOT_RAN || 'false' }}"
          echo "üìù Changes detected: ${{ steps.check_changes.outputs.CHANGES_DETECTED || 'false' }}"
          echo "================================"
