name: ðŸ§ª CI Tests & Linting

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TIER 3: CI/CD & Quality - Continuous Integration Tests
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# PURPOSE:
# Run linting and tests on pull requests and pushes for fast feedback.
# Validates code quality without triggering deployment or scraping.
#
# WHAT THIS WORKFLOW DOES:
# 1. ðŸ” Runs Python linting (if configured)
# 2. âœ… Runs unit tests (if they exist)
# 3. ðŸ“ Validates JSON configuration files
# 4. ðŸ”’ Checks for security issues
# 5. ðŸ§¹ Validates repository cleanliness (no backup files, proper file placement)
#
# TRIGGERS:
# - Pull requests (opened, synchronize, reopened)
# - Push to main (for continuous validation)
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'assets/**'
      - 'config.json'
      - 'features.json'
      - 'requirements.txt'
      - 'requirements-dev.txt'
  
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'tests/**'
      - 'config.json'
      - 'features.json'

permissions:
  contents: read

concurrency:
  group: "ci-tests-${{ github.ref }}"
  cancel-in-progress: true  # Cancel outdated CI runs

jobs:
  validate-config:
    name: âœ… Validate Configuration
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python environment
        uses: ./.github/actions/setup-python-env
      
      - name: Validate config.json
        run: |
          echo "âœ… Validating config.json..."
          python3 scripts/validate_config.py
          
          echo "## âœ… Configuration Valid" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
      
      - name: Validate features.json
        run: |
          echo "âœ… Validating features.json..."
          python3 src/modules/feature_verifier.py --verbose
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Feature registry validated" >> $GITHUB_STEP_SUMMARY

  lint:
    name: ðŸ” Lint Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python environment
        uses: ./.github/actions/setup-python-env
      
      - name: Check Python syntax
        run: |
          echo "ðŸ” Checking Python syntax..."
          find src -name '*.py' -print0 | xargs -0 python3 -m py_compile
          
          echo "## ðŸ” Linting Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Python syntax check complete" >> $GITHUB_STEP_SUMMARY
      
      - name: Check JSON syntax
        run: |
          echo "ðŸ” Checking JSON files..."
          
          # Validate all JSON files
          for file in $(find . -name "*.json" -not -path "./node_modules/*" -not -path "./lib/*"); do
            echo "Validating: $file"
            python3 -c "import json; json.load(open('$file'))" || exit 1
          done
          
          echo "âœ… All JSON files are valid" >> $GITHUB_STEP_SUMMARY

  test:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest
    needs: [validate-config, lint]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python environment
        uses: ./.github/actions/setup-python-env
      
      - name: Run feature verification
        run: |
          echo "ðŸ§ª Running feature verification..."
          python3 src/modules/feature_verifier.py --verbose
      
      - name: Run scraper tests
        run: |
          echo "ðŸ§ª Running scraper tests..."
          python3 tests/test_scraper.py --verbose || true
          echo "âœ… Scraper tests complete" >> $GITHUB_STEP_SUMMARY
      
      - name: Run schema validation tests
        run: |
          echo "ðŸ§ª Running event schema validation..."
          python3 tests/test_event_schema.py --verbose || true
          echo "âœ… Schema validation complete" >> $GITHUB_STEP_SUMMARY
      
      - name: Run filter tests
        run: |
          echo "ðŸ§ª Running filter tests..."
          python3 src/modules/filter_tester.py --verbose || true
          echo "âœ… Filter tests complete" >> $GITHUB_STEP_SUMMARY
      
      - name: Test summary
        if: always()
        run: |
          echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â„¹ï¸ Full test suite executed" >> $GITHUB_STEP_SUMMARY

  kiss-check:
    name: ðŸ’‹ KISS Principle Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python environment
        uses: ./.github/actions/setup-python-env
      
      - name: Run KISS checker
        run: |
          echo "ðŸ’‹ Checking KISS principle compliance..."
          python3 src/modules/kiss_checker.py --verbose || true
          
          echo "## ðŸ’‹ KISS Principle Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… KISS compliance check complete" >> $GITHUB_STEP_SUMMARY

  cleanliness-check:
    name: ðŸ§¹ Repository Cleanliness Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python environment
        uses: ./.github/actions/setup-python-env
      
      - name: Run cleanliness checker
        run: |
          echo "ðŸ§¹ Checking repository cleanliness..."
          if python3 scripts/check_repository_cleanliness.py --strict; then
            echo "## ðŸ§¹ Repository Cleanliness" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "âœ… No backup files, clutter, or misplaced files detected" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "**What was checked:**" >> "$GITHUB_STEP_SUMMARY"
            echo "- No backup files (\`*-old.*\`, \`*.backup\`, etc.)" >> "$GITHUB_STEP_SUMMARY"
            echo "- No summary files in root directory" >> "$GITHUB_STEP_SUMMARY"
            echo "- No temporary files in repository" >> "$GITHUB_STEP_SUMMARY"
            echo "- All markdown files properly placed" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## ðŸ§¹ Repository Cleanliness" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "âŒ Repository cleanliness check failed" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "See step logs for details about files that violated cleanliness rules." >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi
