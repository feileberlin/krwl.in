name: üì¶ Promote Preview to Production

on:
  workflow_dispatch:
    inputs:
      auto_merge:
        description: '‚úÖ Auto-merge the PR (only works without branch protection)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      create_preview_if_missing:
        description: 'üîß Create preview branch from main if it does not exist'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write
  pull-requests: write
  pages: write
  id-token: write

jobs:
  validate-and-promote:
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.promote.outputs.pr_number }}
      pr_url: ${{ steps.promote.outputs.pr_url }}
      action_taken: ${{ steps.promote.outputs.action_taken }}
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîç Validate branches and setup
        id: validate
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const headBranch = 'preview';
            const baseBranch = 'main';
            
            core.info('üîç Validating repository setup...');
            
            // Check if main branch exists
            try {
              await github.rest.repos.getBranch({ owner, repo, branch: baseBranch });
              core.info(`‚úì Base branch '${baseBranch}' exists`);
            } catch (error) {
              core.setFailed(`‚ùå Base branch '${baseBranch}' does not exist: ${error.message}`);
              return;
            }
            
            // Check if preview branch exists
            let previewExists = true;
            try {
              await github.rest.repos.getBranch({ owner, repo, branch: headBranch });
              core.info(`‚úì Head branch '${headBranch}' exists`);
            } catch (error) {
              previewExists = false;
              core.warning(`‚ö†Ô∏è  Head branch '${headBranch}' does not exist`);
            }
            
            // Create preview branch if it doesn't exist and user allows it
            if (!previewExists) {
              const shouldCreate = '${{ inputs.create_preview_if_missing }}' === 'true';
              
              if (shouldCreate) {
                core.info(`üîß Creating '${headBranch}' branch from '${baseBranch}'...`);
                try {
                  // Get main branch reference
                  const { data: mainRef } = await github.rest.git.getRef({
                    owner,
                    repo,
                    ref: `heads/${baseBranch}`
                  });
                  
                  // Create preview branch from main
                  await github.rest.git.createRef({
                    owner,
                    repo,
                    ref: `refs/heads/${headBranch}`,
                    sha: mainRef.object.sha
                  });
                  
                  core.info(`‚úì Created '${headBranch}' branch from '${baseBranch}'`);
                  core.setOutput('preview_created', 'true');
                  
                  // Add workflow summary
                  await core.summary
                    .addHeading('‚úì Preview Branch Created', 2)
                    .addRaw(`The \`${headBranch}\` branch was created from \`${baseBranch}\`.`)
                    .addBreak()
                    .addRaw('üìù **Note**: Both branches are currently identical.')
                    .addBreak()
                    .addRaw('üí° **Next steps**: Make changes to the preview branch, test them, then run this workflow again.')
                    .write();
                  
                  core.notice('Preview branch created successfully. No PR will be created since branches are identical.');
                  core.setOutput('should_create_pr', 'false');
                  return;
                } catch (error) {
                  core.setFailed(`‚ùå Failed to create preview branch: ${error.message}`);
                  return;
                }
              } else {
                core.setFailed(`‚ùå Preview branch '${headBranch}' does not exist. Set 'create_preview_if_missing' to true to create it automatically.`);
                return;
              }
            }
            
            // Compare branches
            try {
              const { data: comparison } = await github.rest.repos.compareCommitsWithBasehead({
                owner,
                repo,
                basehead: `${baseBranch}...${headBranch}`
              });
              
              if (comparison.ahead_by === 0 && comparison.behind_by === 0) {
                core.warning('‚ö†Ô∏è  Branches are identical - no changes to promote');
                await core.summary
                  .addHeading('‚ö†Ô∏è No Changes to Promote', 2)
                  .addRaw(`The \`${headBranch}\` and \`${baseBranch}\` branches are identical.`)
                  .addBreak()
                  .addRaw('üí° **Next steps**: Make changes to the preview branch, test them, then run this workflow again.')
                  .write();
                core.setOutput('should_create_pr', 'false');
                return;
              } else if (comparison.behind_by > 0) {
                core.warning(`‚ö†Ô∏è  Preview branch is ${comparison.behind_by} commit(s) behind main`);
                core.info('This is OK - the PR will merge main changes into preview when created');
              }
              
              core.info(`üìä Comparison: ${comparison.ahead_by} ahead, ${comparison.behind_by} behind`);
              core.setOutput('commits_ahead', comparison.ahead_by.toString());
              core.setOutput('commits_behind', comparison.behind_by.toString());
              core.setOutput('should_create_pr', 'true');
              
            } catch (error) {
              core.setFailed(`‚ùå Failed to compare branches: ${error.message}`);
              return;
            }
            
            core.info('‚úì Validation complete - ready to create PR');

      - name: üöÄ Create or update promotion PR
        id: promote
        if: steps.validate.outputs.should_create_pr == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const headBranch = 'preview';
            const baseBranch = 'main';
            const title = 'üöÄ Promote preview to production';
            
            const commitsAhead = '${{ steps.validate.outputs.commits_ahead }}' || 'unknown';
            const commitsBehind = '${{ steps.validate.outputs.commits_behind }}' || '0';
            
            const body = `## üöÄ Promote Preview to Production
            
            This PR promotes changes from the \`${headBranch}\` branch to \`${baseBranch}\` (production).
            
            ### üìä Changes Summary
            - **Commits ahead of main**: ${commitsAhead}
            - **Commits behind main**: ${commitsBehind}
            
            ### üîÑ What happens when merged:
            - ‚úÖ Production site will be updated with preview changes
            - ‚úÖ Site will use \`config.prod.json\` (optimized for maximum speed, no debugging)
            - ‚úÖ Custom domain (CNAME) will be preserved
            - ‚úÖ Automated event scraping and deployment via \`scrape-events.yml\` workflow (runs twice daily)
            
            ### ‚úÖ Testing checklist:
            - [ ] Preview site tested at \`/preview/\` path
            - [ ] All features working correctly
            - [ ] No console errors in production mode
            - [ ] Performance is acceptable
            - [ ] Mobile experience tested
            - [ ] Debug mode disabled in production
            
            ### üîß Deployment Configuration
            - **Preview config**: \`config.dev.json\` (debug enabled, demo data)
            - **Production config**: \`config.prod.json\` (optimized, real data only)
            
            ---
            
            *ü§ñ Auto-merge requested: ${{ inputs.auto_merge }}*
            *‚è∞ Workflow run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*`;
            
            let actionTaken = 'unknown';
            
            try {
              // Check if PR already exists
              core.info('üîç Checking for existing PRs...');
              const { data: pulls } = await github.rest.pulls.list({
                owner,
                repo,
                head: `${owner}:${headBranch}`,
                base: baseBranch,
                state: 'open'
              });
              
              let pr;
              if (pulls.length > 0) {
                // Update existing PR
                pr = pulls[0];
                core.info(`üìù Updating existing PR #${pr.number}`);
                await github.rest.pulls.update({
                  owner,
                  repo,
                  pull_number: pr.number,
                  title,
                  body
                });
                actionTaken = 'updated';
                core.notice(`‚úì Updated existing PR #${pr.number}: ${pr.html_url}`);
              } else {
                // Create new PR
                core.info('üìù Creating new PR...');
                try {
                  const { data: newPr } = await github.rest.pulls.create({
                    owner,
                    repo,
                    title,
                    head: headBranch,
                    base: baseBranch,
                    body
                  });
                  pr = newPr;
                  actionTaken = 'created';
                  core.notice(`‚úì Created new PR #${pr.number}: ${pr.html_url}`);
                } catch (createError) {
                  if (createError.message.includes('No commits between')) {
                    core.warning('‚ö†Ô∏è  No commits between branches - nothing to promote');
                    actionTaken = 'skipped_no_changes';
                    
                    await core.summary
                      .addHeading('‚ö†Ô∏è No Changes to Promote', 2)
                      .addRaw('The branches are already in sync.')
                      .write();
                    
                    return;
                  }
                  throw createError;
                }
              }
              
              // Set outputs
              core.setOutput('pr_number', pr.number.toString());
              core.setOutput('pr_url', pr.html_url);
              core.setOutput('action_taken', actionTaken);
              
              // Try to auto-merge if requested
              if ('${{ inputs.auto_merge }}' === 'true') {
                core.info('ü§ñ Attempting auto-merge...');
                try {
                  await github.rest.pulls.merge({
                    owner,
                    repo,
                    pull_number: pr.number,
                    merge_method: 'merge'
                  });
                  core.notice(`‚úì PR #${pr.number} auto-merged successfully!`);
                  actionTaken = 'auto_merged';
                  core.setOutput('action_taken', actionTaken);
                  
                  await core.summary
                    .addHeading('‚úì Auto-merge Successful', 2)
                    .addRaw(`PR #${pr.number} was automatically merged to production.`)
                    .addBreak()
                    .addLink('View PR', pr.html_url)
                    .write();
                  
                } catch (mergeError) {
                  core.warning(`‚ö†Ô∏è  Could not auto-merge PR #${pr.number}: ${mergeError.message}`);
                  core.info('This is expected if branch protection rules are enabled.');
                  core.info('Please merge the PR manually after review.');
                  
                  await core.summary
                    .addHeading('‚ö†Ô∏è Auto-merge Blocked', 2)
                    .addRaw(`PR #${pr.number} was created but could not be automatically merged.`)
                    .addBreak()
                    .addRaw(`**Reason**: ${mergeError.message}`)
                    .addBreak()
                    .addRaw('This is normal if branch protection is enabled. Please review and merge manually.')
                    .addBreak()
                    .addLink('Review and Merge PR', pr.html_url)
                    .write();
                }
              } else {
                // Manual merge requested
                await core.summary
                  .addHeading(`‚úì PR ${actionTaken === 'created' ? 'Created' : 'Updated'}`, 2)
                  .addRaw(`PR #${pr.number} is ready for review.`)
                  .addBreak()
                  .addRaw(`**Commits to merge**: ${commitsAhead}`)
                  .addBreak()
                  .addLink('Review and Merge PR', pr.html_url)
                  .write();
              }
              
            } catch (error) {
              core.setFailed(`‚ùå Failed to create/update PR: ${error.message}`);
              await core.summary
                .addHeading('‚ùå Workflow Failed', 2)
                .addRaw(`Error: ${error.message}`)
                .addBreak()
                .addRaw('Please check the workflow logs for details.')
                .write();
              throw error;
            }
