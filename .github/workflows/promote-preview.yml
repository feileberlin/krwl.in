name: Promote Preview to Production

on:
  workflow_dispatch:
    inputs:
      auto_merge:
        description: 'Auto-merge the PR (true/false)'
        required: false
        default: 'false'
        type: string

permissions:
  contents: write
  pull-requests: write
  pages: write
  id-token: write

jobs:
  promote:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create or update promotion PR
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const headBranch = 'preview';
            const baseBranch = 'main';
            const title = 'Promote preview to production';
            const body = `## ðŸš€ Promote Preview to Production
            
            This PR promotes changes from the \`preview\` branch to \`main\` (production).
            
            ### What happens when merged:
            - Production site will be updated with preview changes
            - Site will use \`config.prod.json\` (optimized for maximum speed, no debugging)
            - Custom domain (CNAME) will be preserved
            
            ### Testing checklist:
            - [ ] Preview site tested at /preview/ path
            - [ ] All features working correctly
            - [ ] No console errors in production mode
            - [ ] Performance is acceptable
            
            ---
            *Auto-merge requested: ${{ inputs.auto_merge }}*`;
            
            // Check if PR already exists
            const { data: pulls } = await github.rest.pulls.list({
              owner,
              repo,
              head: `${owner}:${headBranch}`,
              base: baseBranch,
              state: 'open'
            });
            
            let pr;
            if (pulls.length > 0) {
              // Update existing PR
              pr = pulls[0];
              await github.rest.pulls.update({
                owner,
                repo,
                pull_number: pr.number,
                body
              });
              console.log(`Updated existing PR #${pr.number}`);
            } else {
              // Create new PR
              const { data: newPr } = await github.rest.pulls.create({
                owner,
                repo,
                title,
                head: headBranch,
                base: baseBranch,
                body
              });
              pr = newPr;
              console.log(`Created new PR #${pr.number}`);
            }
            
            // Try to auto-merge if requested
            if ('${{ inputs.auto_merge }}' === 'true') {
              try {
                await github.rest.pulls.merge({
                  owner,
                  repo,
                  pull_number: pr.number,
                  merge_method: 'merge'
                });
                console.log(`âœ“ PR #${pr.number} auto-merged successfully`);
              } catch (error) {
                console.log(`âš  Could not auto-merge PR #${pr.number}: ${error.message}`);
                console.log('This is expected if branch protection rules are enabled.');
                console.log('Please merge the PR manually.');
              }
            }
            
            console.log(`PR URL: ${pr.html_url}`);
