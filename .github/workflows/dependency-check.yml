name: ðŸ”’ Dependency Security Check

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TIER 3: CI/CD & Quality - Dependency Security Audits
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# PURPOSE:
# Weekly security audit of Python dependencies for vulnerabilities.
# Checks for outdated packages and creates issues for updates needed.
#
# WHAT THIS WORKFLOW DOES:
# 1. ðŸ” Scans Python dependencies for known vulnerabilities
# 2. ðŸ“Š Checks for outdated packages
# 3. ðŸš¨ Creates GitHub issues for security concerns
# 4. ðŸ“ Provides detailed audit report
#
# TRIGGERS:
# - Scheduled: Weekly on Monday mornings (08:00 UTC)
# - Manual: Via "Run workflow" button
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

on:
  schedule:
    - cron: '0 8 * * 1'  # Every Monday at 08:00 UTC
  
  workflow_dispatch:

permissions:
  contents: read
  issues: write  # Create issues for security concerns

concurrency:
  group: "dependency-check"
  cancel-in-progress: false  # Let security checks finish

jobs:
  check-dependencies:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python environment
        uses: ./.github/actions/setup-python-env
      
      - name: Check for outdated packages
        id: outdated
        run: |
          echo "ðŸ“Š Checking for outdated packages..."
          
          # Get list of outdated packages
          OUTDATED=$(pip list --outdated --format=json 2>/dev/null || echo "[]")
          echo "outdated=$OUTDATED" >> $GITHUB_OUTPUT
          
          # Count outdated packages
          OUTDATED_COUNT=$(echo "$OUTDATED" | python3 -c "import sys, json; print(len(json.load(sys.stdin)))")
          echo "outdated_count=$OUTDATED_COUNT" >> $GITHUB_OUTPUT
          
          echo "## ðŸ“Š Dependency Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Outdated packages:** $OUTDATED_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$OUTDATED_COUNT" -gt 0 ]; then
            echo "### ðŸ“¦ Outdated Packages" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            echo "$OUTDATED" | python3 -m json.tool >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All packages are up to date" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Run pip-audit (security vulnerabilities)
        id: audit
        continue-on-error: true
        run: |
          echo "ðŸ” Running security audit..."
          
          # Install pip-audit if available
          pip install pip-audit 2>/dev/null || {
            echo "âš ï¸ pip-audit not available, skipping vulnerability scan" >> $GITHUB_STEP_SUMMARY
            exit 0
          }
          
          # Run audit and capture output
          AUDIT_OUTPUT=$(pip-audit --format=json 2>&1 || true)
          echo "audit_output<<EOF" >> $GITHUB_OUTPUT
          echo "$AUDIT_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Check if vulnerabilities found
          VULN_COUNT=$(echo "$AUDIT_OUTPUT" | python3 -c "import sys, json; data = json.loads(sys.stdin.read()); print(len(data.get('vulnerabilities', [])))" 2>/dev/null || echo "0")
          echo "vulnerability_count=$VULN_COUNT" >> $GITHUB_OUTPUT
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”’ Security Vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$VULN_COUNT" -gt 0 ]; then
            echo "âš ï¸ **Found $VULN_COUNT vulnerabilities**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            echo "$AUDIT_OUTPUT" | python3 -m json.tool >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No known vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Create issue for vulnerabilities
        if: steps.audit.outputs.vulnerability_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const vulnCount = '${{ steps.audit.outputs.vulnerability_count }}';
            const auditOutput = `${{ steps.audit.outputs.audit_output }}`;
            
            const issueTitle = `ðŸ”’ Security Alert: ${vulnCount} vulnerabilities found in dependencies`;
            const issueBody = `## ðŸ”’ Dependency Security Audit
            
            **Date:** ${new Date().toUTCString()}
            **Vulnerabilities Found:** ${vulnCount}
            
            ### ðŸ“Š Audit Results
            
            \`\`\`json
            ${auditOutput}
            \`\`\`
            
            ### ðŸ”§ Action Required
            
            Please review the vulnerabilities above and:
            1. Update affected packages to secure versions
            2. Check if updates break any functionality
            3. Test thoroughly before deploying
            4. Close this issue once resolved
            
            ### ðŸ“ Resources
            
            - [pip-audit documentation](https://github.com/pypa/pip-audit)
            - [Python Security Advisories](https://github.com/advisories?query=ecosystem%3Apip)
            
            ---
            
            *This issue was automatically created by the dependency-check workflow*`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: ['security', 'dependencies']
            });
      
      - name: Create issue for outdated packages
        if: steps.outdated.outputs.outdated_count > 5
        uses: actions/github-script@v7
        with:
          script: |
            const outdatedCount = '${{ steps.outdated.outputs.outdated_count }}';
            const outdatedList = ${{ steps.outdated.outputs.outdated }};
            
            const issueTitle = `ðŸ“¦ Update Required: ${outdatedCount} outdated dependencies`;
            const issueBody = `## ðŸ“¦ Dependency Update Check
            
            **Date:** ${new Date().toUTCString()}
            **Outdated Packages:** ${outdatedCount}
            
            ### ðŸ“Š Packages Needing Updates
            
            ${outdatedList.map(pkg => 
              `- **${pkg.name}**: ${pkg.version} â†’ ${pkg.latest_version}`
            ).join('\n')}
            
            ### ðŸ”§ Recommended Actions
            
            1. Review release notes for each package
            2. Update packages in \`requirements.txt\`
            3. Test for breaking changes
            4. Update if safe to do so
            
            ### â„¹ï¸ Update Commands
            
            \`\`\`bash
            # Update all packages (use with caution)
            pip install --upgrade -r requirements.txt
            
            # Or update specific packages
            pip install --upgrade package_name
            \`\`\`
            
            ---
            
            *This issue was automatically created by the dependency-check workflow*`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: ['dependencies', 'maintenance']
            });
      
      - name: Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Next check:** Next Monday at 08:00 UTC" >> $GITHUB_STEP_SUMMARY
