name: ðŸ” PR Preview Build

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TIER 3: CI/CD & Quality - Pull Request Previews
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# PURPOSE:
# Build preview site for pull requests to help reviewers see changes.
# Does NOT deploy to production - only creates artifact for review.
#
# WHAT THIS WORKFLOW DOES:
# 1. ðŸ”¨ Builds static site with PR changes
# 2. ðŸ“¦ Uploads preview artifact
# 3. ðŸ’¬ Comments on PR with preview instructions
# 4. ðŸ” Helps reviewers visualize changes before merge
#
# TRIGGERS:
# - Pull requests (opened, synchronize, reopened)
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'src/**'
      - 'assets/**'
      - 'config.json'
      - '.github/workflows/pr-preview.yml'

permissions:
  contents: read
  pull-requests: write  # Comment on PRs

concurrency:
  group: "pr-preview-${{ github.event.pull_request.number }}"
  cancel-in-progress: true  # Cancel outdated preview builds

jobs:
  build-preview:
    name: ðŸ”¨ Build PR Preview
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
      
      - name: Setup Python environment
        uses: ./.github/actions/setup-python-env
      
      - name: Fetch dependencies
        run: |
          echo "ðŸ“¦ Fetching dependencies for preview..."
          python3 src/event_manager.py dependencies fetch || echo "âš ï¸ Dependency fetch failed - will use CDN fallbacks"
      
      - name: Generate preview site
        run: |
          echo "ðŸ”¨ Building preview site for PR #${{ github.event.pull_request.number }}..."
          python3 src/event_manager.py generate
          
          echo "## ðŸ” PR Preview Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.event.pull_request.head.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload preview artifact
        uses: actions/upload-artifact@v4
        with:
          name: pr-preview-${{ github.event.pull_request.number }}
          path: public/
          retention-days: 7
      
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const runId = context.runId;
            const repo = context.repo;
            
            const comment = `## ðŸ” PR Preview Build Complete
            
            **Build Status:** âœ… Success
            **Time:** ${new Date().toUTCString()}
            
            ### ðŸ“¦ Preview Artifact
            
            A preview build has been created for this PR. To view it:
            
            1. Go to the [workflow run](https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId})
            2. Download the \`pr-preview-${prNumber}\` artifact
            3. Extract and open \`public/index.html\` in your browser
            
            ### â„¹ï¸ Note
            
            This is a **preview build only** - it has NOT been deployed to production.
            The preview includes all changes from this PR for review purposes.
            
            ---
            
            *Preview builds are retained for 7 days*`;
            
            // Find existing preview comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: prNumber,
            });
            
            const existingComment = comments.find(c => 
              c.user.type === 'Bot' && c.body.includes('ðŸ” PR Preview Build')
            );
            
            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: repo.owner,
                repo: repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: repo.owner,
                repo: repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }
      
      - name: Build summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Preview artifact uploaded successfully" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ PR comment posted with preview instructions" >> $GITHUB_STEP_SUMMARY
