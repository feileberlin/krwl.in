name: üîç PR Preview Build (KISS)

# Simple PR preview using GitHub Actions artifacts
# Build the site and upload as downloadable artifact - No deployment complexity!
# Respects KISS: No external services, no tokens, just artifacts

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      # Trigger on changes that affect site generation
      - 'assets/css/**'
      - 'assets/js/**'
      - 'assets/html/**'
      - 'assets/json/**'
      - 'config.json'
      - 'src/**'
      - '.github/workflows/pr-preview.yml'
  
  workflow_dispatch:
    inputs:
      enable_previews:
        description: 'Enable PR previews globally'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: read
  pull-requests: write  # For commenting on PR

# Only one preview build per PR at a time
concurrency:
  group: "pr-preview-${{ github.event.pull_request.number }}"
  cancel-in-progress: true

jobs:
  check-enabled:
    name: üîç Check if Previews are Enabled
    runs-on: ubuntu-latest
    outputs:
      enabled: ${{ steps.check.outputs.enabled }}
    
    steps:
      - name: Check if previews are enabled
        id: check
        run: |
          # Check if manually disabled via workflow_dispatch
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.enable_previews }}" = "false" ]; then
            echo "enabled=false" >> $GITHUB_OUTPUT
            echo "‚ùå PR previews manually disabled via workflow_dispatch"
            exit 0
          fi
          
          # Check if disabled via environment variable (repository secret)
          if [ "${{ vars.PR_PREVIEWS_ENABLED }}" = "false" ]; then
            echo "enabled=false" >> $GITHUB_OUTPUT
            echo "‚ùå PR previews disabled via repository variable PR_PREVIEWS_ENABLED"
            exit 0
          fi
          
          # Enabled by default
          echo "enabled=true" >> $GITHUB_OUTPUT
          echo "‚úÖ PR previews enabled"
      
      - name: Post disabled message on PR
        if: steps.check.outputs.enabled == 'false' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            
            const comment = `## ‚ÑπÔ∏è PR Previews Currently Disabled
            
            PR preview generation is currently disabled for this repository.
            
            **To test your changes locally:**
            
            \`\`\`bash
            # Checkout this PR branch
            git checkout ${{ github.event.pull_request.head.ref }}
            
            # Install dependencies
            pip install -r requirements.txt
            
            # Generate site
            python3 src/event_manager.py generate
            
            # Test locally
            cd public && python3 -m http.server 8000
            # Open http://localhost:8000
            \`\`\`
            
            **To re-enable PR previews:**
            See [PR Preview Disable Guide](../../docs/PR_PREVIEW_DISABLE.md) for instructions.
            
            ---
            
            üí° **Tip:** PR previews can be re-enabled by repository admins via Settings ‚Üí Actions ‚Üí Variables.
            `;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
  
  build-preview:
    name: üî® Build PR Preview
    runs-on: ubuntu-latest
    needs: check-enabled
    if: needs.check-enabled.outputs.enabled == 'true'
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Fetch frontend libraries (Leaflet, fonts)
        run: |
          python3 src/event_manager.py dependencies fetch
      
      - name: Generate preview site
        env:
          # Force development mode for preview
          ENVIRONMENT: development
        run: |
          echo "üî® Building preview site in development mode..."
          echo "   (includes demo events and DEV watermark)"
          python3 src/event_manager.py generate
          
          # Add preview notice to HTML
          PREVIEW_NOTICE="<!-- PR #${{ github.event.pull_request.number }} Preview Build -->"
          sed -i "1i $PREVIEW_NOTICE" public/index.html
          
          echo "‚úì Preview site built successfully"
      
      - name: Generate CSS color preview
        id: color_preview
        run: |
          echo "üé® Generating CSS color variable preview..."
          
          # Generate HTML color preview
          python3 src/tools/generate_color_preview.py assets/html/design-tokens.css \
            -o public/color-preview.html
          
          # Generate markdown for PR comment
          python3 src/tools/generate_color_preview.py assets/html/design-tokens.css \
            -m -o /tmp/color-preview.md
          
          # Check if colors changed
          if git diff HEAD^ HEAD -- assets/html/design-tokens.css > /dev/null 2>&1; then
            echo "colors_changed=true" >> $GITHUB_OUTPUT
            echo "‚úì Colors changed - preview will be shown"
          else
            echo "colors_changed=false" >> $GITHUB_OUTPUT
            echo "‚Ñπ No color changes detected"
          fi
          
          echo "‚úì Color preview generated"
      
      - name: Install Playwright (for screenshots)
        run: |
          echo "üì∏ Installing Playwright for screenshots..."
          pip install playwright
          playwright install chromium
          echo "‚úì Playwright installed"
      
      - name: Take screenshots
        id: screenshots
        run: |
          echo "üì∏ Taking screenshots of generated site..."
          
          # Create screenshots directory
          mkdir -p public/screenshots
          
          # Start local server in background
          cd public
          python3 -m http.server 8000 &
          SERVER_PID=$!
          sleep 3  # Wait for server to start
          
          # Take screenshots using Playwright
          cd ..
          python3 << 'PYTHON_SCRIPT'
import asyncio
from playwright.async_api import async_playwright

async def take_screenshots():
    async with async_playwright() as p:
        browser = await p.chromium.launch()
        
        # Desktop screenshot
        page = await browser.new_page(viewport={'width': 1920, 'height': 1080})
        await page.goto('http://localhost:8000/')
        await page.wait_for_timeout(3000)  # Wait for map to load
        await page.screenshot(path='public/screenshots/desktop.png', full_page=True)
        print("‚úì Desktop screenshot taken (1920x1080)")
        
        # Mobile screenshot
        mobile_page = await browser.new_page(viewport={'width': 375, 'height': 667})
        await mobile_page.goto('http://localhost:8000/')
        await mobile_page.wait_for_timeout(3000)  # Wait for map to load
        await mobile_page.screenshot(path='public/screenshots/mobile.png', full_page=True)
        print("‚úì Mobile screenshot taken (375x667)")
        
        await browser.close()

asyncio.run(take_screenshots())
PYTHON_SCRIPT
          
          # Stop server
          kill $SERVER_PID 2>/dev/null || true
          
          echo "screenshots_taken=true" >> $GITHUB_OUTPUT
          echo "‚úì Screenshots captured"
      
      - name: Upload screenshots as separate artifact
        if: steps.screenshots.outputs.screenshots_taken == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: pr-${{ github.event.pull_request.number }}-screenshots
          path: public/screenshots/
          retention-days: 90
      
      - name: Create preview info file
        run: |
          cat > public/PREVIEW_INFO.txt << 'EOF'
          ========================================
          PR PREVIEW BUILD
          ========================================
          
          PR Number: #${{ github.event.pull_request.number }}
          Branch: ${{ github.event.pull_request.head.ref }}
          Commit: ${{ github.event.pull_request.head.sha }}
          Author: ${{ github.event.pull_request.user.login }}
          Built: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          ========================================
          HOW TO TEST THIS PREVIEW
          ========================================
          
          Option 1: Local Testing (Recommended)
          -------------------------------------
          1. Download the artifact from GitHub Actions
          2. Extract the zip file
          3. Open 'public/index.html' in your browser
          
          Option 2: Local Server
          ----------------------
          1. Download and extract the artifact
          2. cd public
          3. python3 -m http.server 8000
          4. Open http://localhost:8000
          
          ========================================
          NOTES
          ========================================
          
          - Preview built in DEVELOPMENT mode
          - Includes demo events (pink markers)
          - Shows DEV watermark in UI
          - Valid for 90 days (artifact retention)
          
          ========================================
          EOF
      
      - name: Upload preview artifact
        uses: actions/upload-artifact@v4
        with:
          name: pr-${{ github.event.pull_request.number }}-preview
          path: public/
          retention-days: 90
          compression-level: 9
      
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const runId = context.runId;
            const sha = context.payload.pull_request.head.sha.substring(0, 7);
            const fs = require('fs');
            
            // Read color preview markdown if it exists
            let colorPreview = '';
            try {
              colorPreview = fs.readFileSync('/tmp/color-preview.md', 'utf8');
            } catch (e) {
              // Color preview not generated
            }
            
            let comment = `## üîç PR Preview Built Successfully
            
            A preview of this PR has been generated and is available for download!
            
            ### üì¶ Download Artifacts
            
            **Main Preview:** \`pr-${prNumber}-preview\` (includes HTML, color preview, screenshots)
            
            üëâ [Download Preview Artifact](https://github.com/${{ github.repository }}/actions/runs/${runId})
            
            **Screenshots:** \`pr-${prNumber}-screenshots\` (separate download)
            
            üëâ [Download Screenshots](https://github.com/${{ github.repository }}/actions/runs/${runId})
            
            ### üé® Color Preview
            
            CSS color variables are included in the preview artifact:
            - Open \`public/color-preview.html\` in browser to see all colors
            - Visual swatches for all CSS variables
            - Organized by category (Primary, Tints, Shades, etc.)
            
            `;
            
            // Add color preview to comment if colors changed
            if (colorPreview) {
              comment += `\n<details>\n<summary>üìä CSS Color Variables (Click to expand)</summary>\n\n${colorPreview}\n\n</details>\n\n`;
            }
            
            comment += `### üì∏ Screenshots
            
            Screenshots are available in the artifacts:
            - \`desktop.png\` - Desktop view (1920x1080)
            - \`mobile.png\` - Mobile view (375x667)
            
            Download the screenshots artifact to view them, or extract the main preview artifact and check \`public/screenshots/\` directory.
            
            ### üöÄ How to Test
            
            **Quick Test (Just open file):**
            1. Download \`pr-${prNumber}-preview\` artifact from link above
            2. Extract the zip file
            3. Open \`public/index.html\` in your browser
            
            **Local Server (Better for testing):**
            \`\`\`bash
            # After extracting the artifact
            cd public
            python3 -m http.server 8000
            # Open http://localhost:8000
            \`\`\`
            
            **View Color Preview:**
            \`\`\`bash
            # After extracting the artifact
            open public/color-preview.html  # macOS
            xdg-open public/color-preview.html  # Linux
            \`\`\`
            
            ### ‚ÑπÔ∏è Preview Details
            
            - **Mode:** Development (includes demo events)
            - **Commit:** \`${sha}\`
            - **Built:** ${new Date().toUTCString()}
            - **Valid:** 90 days
            
            ### üéØ What to Check
            
            - [ ] Map loads correctly with all markers
            - [ ] Filters work as expected
            - [ ] UI/UX changes display properly
            - [ ] Mobile responsiveness (resize browser)
            - [ ] No console errors (check browser DevTools)
            
            ---
            
            üí° **Tip:** Preview is built in development mode, so you'll see demo events (pink markers) and a DEV watermark. This is normal!
            `;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Summary
        run: |
          echo "## üîç PR Preview Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.event.pull_request.head.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.event.pull_request.head.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Preview artifact uploaded successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artifact:** \`pr-${{ github.event.pull_request.number }}-preview\`" >> $GITHUB_STEP_SUMMARY
          echo "**Retention:** 90 days" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì• How to Download" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to the [Actions tab](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "2. Scroll to 'Artifacts' section" >> $GITHUB_STEP_SUMMARY
          echo "3. Download \`pr-${{ github.event.pull_request.number }}-preview\`" >> $GITHUB_STEP_SUMMARY
          echo "4. Extract and open \`public/index.html\`" >> $GITHUB_STEP_SUMMARY
