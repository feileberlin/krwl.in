name: ðŸŽ­ Generate Demo Events

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for generating demo events (optional)'
        required: false
        default: 'Manual demo event generation triggered'
        type: string

permissions:
  contents: write

jobs:
  generate-demo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Generate demo events
        run: |
          echo "ðŸŽ­ Generating demo events with current timestamps..."
          # Script outputs JSON to stdout and diagnostics to stderr
          # We capture both but only save JSON to file
          python3 scripts/generate_demo_events.py > /tmp/events.demo.json 2>&1
          
          # Extract just the JSON part (after the stderr diagnostic messages)
          # Find the first line starting with '{' and take everything from there
          sed -n '/{/,$p' /tmp/events.demo.json > static/events.demo.json
          
          # Check if file was created successfully
          if [ -f static/events.demo.json ] && [ -s static/events.demo.json ]; then
            echo "âœ“ Demo events generated successfully"
            
            # Show summary of generated events
            event_count=$(python3 -c "import json; data = json.load(open('static/events.demo.json')); print(len(data.get('events', [])))" 2>/dev/null || echo "unknown")
            echo "âœ“ Generated $event_count demo events"
            
            # Display file size
            file_size=$(du -h static/events.demo.json | cut -f1)
            echo "âœ“ File size: $file_size"
          else
            echo "âŒ Failed to generate demo events"
            cat /tmp/events.demo.json
            exit 1
          fi

      - name: Check for changes
        id: check_changes
        run: |
          if [[ -n $(git status --porcelain static/events.demo.json) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "âœ“ Demo events file has changes"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ No changes in demo events (file already up to date)"
          fi

      - name: Commit demo events
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git add static/events.demo.json
          git commit -m "chore: regenerate demo events - $(date -u +"%Y-%m-%d %H:%M UTC")"
          echo "âœ“ Changes committed"

      - name: Push changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git push
          echo "âœ“ Changes pushed to repository"

      - name: Summary
        run: |
          echo "## ðŸŽ­ Demo Events Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date -u +"%Y-%m-%d %H:%M UTC")" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_changes.outputs.changes }}" == "true" ]; then
            echo "- **Status**: âœ… Demo events generated and committed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status**: â„¹ï¸ No changes (demo events already up to date)" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Get event count
          if [[ -f static/events.demo.json ]]; then
            event_count=$(python3 -c "import json; data = json.load(open('static/events.demo.json')); print(len(data.get('events', [])))" 2>/dev/null || echo "unknown")
            echo "- **Events Generated**: $event_count" >> $GITHUB_STEP_SUMMARY
            
            # Get timestamp from file
            generated_at=$(python3 -c "import json; data = json.load(open('static/events.demo.json')); print(data.get('demo_generated_at', 'unknown'))" 2>/dev/null || echo "unknown")
            echo "- **Generated At**: $generated_at" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“– How to View Demo Events" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Option 1: Preview Environment (Recommended)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Demo events are automatically included in the preview environment:" >> $GITHUB_STEP_SUMMARY
          echo "1. Push your changes to the \`preview\` branch" >> $GITHUB_STEP_SUMMARY
          echo "2. Wait for the **Deploy Preview Environment** workflow to complete" >> $GITHUB_STEP_SUMMARY
          echo "3. Visit the preview URL at \`/preview/\` path (shown in workflow output)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Option 2: Local Development" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To view demo events locally:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo '# 1. Pull the latest changes' >> $GITHUB_STEP_SUMMARY
          echo 'git pull' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '# 2. Copy config to use both demo and real events' >> $GITHUB_STEP_SUMMARY
          echo 'cp config.dev.json static/config.json' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '# 3. Start local server' >> $GITHUB_STEP_SUMMARY
          echo 'cd static' >> $GITHUB_STEP_SUMMARY
          echo 'python3 -m http.server 8000' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '# 4. Open browser to http://localhost:8000' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Option 3: Production Website (Not Recommended)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Warning**: Demo events should NOT be shown on production." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The production config (\`config.prod.json\`) uses \`data.source: \"real\"\` to show only real events." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Demo events are now available in \`static/events.demo.json\`" >> $GITHUB_STEP_SUMMARY
          echo "- Use the preview environment to test event filtering, map display, and UI" >> $GITHUB_STEP_SUMMARY
          echo "- Demo events include various test scenarios:" >> $GITHUB_STEP_SUMMARY
          echo "  - Events happening now" >> $GITHUB_STEP_SUMMARY
          echo "  - Events starting soon (5, 15, 30 minutes)" >> $GITHUB_STEP_SUMMARY
          echo "  - Sunrise edge cases (for time filtering tests)" >> $GITHUB_STEP_SUMMARY
          echo "  - Timezone test cases (UTC+1, UTC+2, UTC-5, etc.)" >> $GITHUB_STEP_SUMMARY
          echo "  - Distance test cases (far away event in Berlin)" >> $GITHUB_STEP_SUMMARY
