name: ðŸ”„ Manual Event & Weather Scraping

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TIER 2: Manual Operations - On-Demand Scraping
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# PURPOSE:
# Allow manual triggering of event and weather scraping with flexible options.
# Use when you need immediate data refresh outside scheduled times.
#
# WHAT THIS WORKFLOW DOES:
# 1. ðŸ“¥ Scrapes events from RSS/HTML sources (optional)
# 2. ðŸŒ¤ï¸ Scrapes weather data (optional)
# 3. ðŸ’¾ Commits changes automatically
# 4. ðŸš€ Optionally triggers full rebuild and deployment
#
# TRIGGERS:
# - Manual only: Via "Run workflow" button
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

on:
  workflow_dispatch:
    inputs:
      scrape_events:
        description: 'Scrape events from sources'
        type: boolean
        default: true
        required: false
      
      scrape_weather:
        description: 'Scrape weather data'
        type: boolean
        default: true
        required: false
      
      force_refresh:
        description: 'Force refresh (bypass cache)'
        type: boolean
        default: false
        required: false
      
      trigger_deploy:
        description: 'Trigger deployment after scraping'
        type: boolean
        default: false
        required: false

permissions:
  contents: write  # Push commits (scraped data)

concurrency:
  group: "manual-scrape"
  cancel-in-progress: true  # Cancel in-progress manual scrapes

jobs:
  scrape-events:
    name: ðŸ“¥ Scrape Events
    runs-on: ubuntu-latest
    if: github.event.inputs.scrape_events == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python environment
        uses: ./.github/actions/setup-python-env
      
      - name: Scrape events
        run: |
          echo "ðŸ“¥ Manually scraping events..."
          python3 src/event_manager.py scrape
          
          echo "## ðŸ“¥ Event Scraping Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
      
      - name: Check for changes
        id: check_changes
        run: |
          git diff --exit-code assets/json/pending_events.json || echo "changes=true" >> $GITHUB_OUTPUT
      
      - name: Commit changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add assets/json/pending_events.json
          git commit -m "ðŸ”„ Manual event scraping by ${{ github.actor }}"
          git push
          
          echo "âœ… Scraped events committed and pushed" >> $GITHUB_STEP_SUMMARY
      
      - name: No changes
        if: steps.check_changes.outputs.changes != 'true'
        run: |
          echo "â„¹ï¸ No new events found" >> $GITHUB_STEP_SUMMARY

  scrape-weather:
    name: ðŸŒ¤ï¸ Scrape Weather
    runs-on: ubuntu-latest
    needs: scrape-events
    if: |
      always() &&
      github.event.inputs.scrape_weather == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Pull latest changes
        run: |
          git pull --rebase origin main
      
      - name: Setup Python environment
        uses: ./.github/actions/setup-python-env
      
      - name: Check weather enabled
        id: check_enabled
        run: |
          WEATHER_ENABLED=$(python3 -c "import json; print(json.load(open('config.json'))['weather']['enabled'])")
          echo "enabled=$WEATHER_ENABLED" >> $GITHUB_OUTPUT
          
          if [ "$WEATHER_ENABLED" = "False" ]; then
            echo "âš ï¸ Weather scraping is disabled in config.json" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
      
      - name: Scrape weather
        if: steps.check_enabled.outputs.enabled == 'True'
        run: |
          echo "ðŸŒ¤ï¸ Manually scraping weather..."
          
          FORCE_FLAG=""
          if [ "${{ github.event.inputs.force_refresh }}" = "true" ]; then
            FORCE_FLAG="--force"
            echo "âš¡ Force refresh enabled (bypassing cache)" >> $GITHUB_STEP_SUMMARY
          fi
          
          python3 src/event_manager.py scrape-weather $FORCE_FLAG
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŒ¤ï¸ Weather Scraping Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
      
      - name: Check for changes
        if: steps.check_enabled.outputs.enabled == 'True'
        id: check_changes
        run: |
          # Check for new, modified, or ignored files
          if [ -n "$(git status --porcelain --ignored -- assets/json/weather_cache.json)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit changes
        if: steps.check_enabled.outputs.enabled == 'True' && steps.check_changes.outputs.changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -f assets/json/weather_cache.json
          git commit -m "ðŸŒ¤ï¸ Manual weather scraping by ${{ github.actor }}"
          git push
          
          echo "âœ… Weather data committed and pushed" >> $GITHUB_STEP_SUMMARY
      
      - name: No changes
        if: steps.check_enabled.outputs.enabled == 'True' && steps.check_changes.outputs.changes != 'true'
        run: |
          echo "â„¹ï¸ Weather data unchanged" >> $GITHUB_STEP_SUMMARY

  trigger-deployment:
    name: ðŸš€ Trigger Deployment
    runs-on: ubuntu-latest
    needs: [scrape-events, scrape-weather]
    if: |
      always() &&
      github.event.inputs.trigger_deploy == 'true'
    
    steps:
      - name: Trigger deploy workflow
        run: |
          echo "ðŸš€ Deployment will be triggered by the push to main branch" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â„¹ï¸ The deploy.yml workflow will handle the build and deployment" >> $GITHUB_STEP_SUMMARY
