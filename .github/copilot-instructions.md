# Copilot Instructions for KRWL HOF Community Events

## Project Overview

KRWL HOF is a **mobile-first Progressive Web App (PWA)** for discovering community events with interactive map visualization. The project uses a Python backend for event scraping/management and a vanilla JavaScript frontend with Leaflet.js for mapping.

### Architecture
- **Backend**: Python 3.x with modular TUI (Text User Interface)
- **Frontend**: Vanilla JavaScript (no frameworks), Leaflet.js for maps
- **Deployment**: Static site generation â†’ GitHub Pages
- **Data Flow**: Scraping â†’ Pending queue â†’ Editorial review â†’ Published events

## Technology Stack

### Backend (Python)
- **Core**: Python 3.x, modular design
- **Dependencies**: requests>=2.31.0, beautifulsoup4>=4.12.0, lxml>=4.9.0, feedparser>=6.0.10 (see `requirements.txt`)
- **Key Modules**:
  - `src/main.py` - TUI entry point and CLI
  - `src/modules/scraper.py` - Event scraping (RSS, HTML, API)
  - `src/modules/editor.py` - Editorial workflow
  - `src/modules/builder.py` - Unified build system (libs + HTML generation)
  - `src/modules/filter_tester.py` - Filter testing
  - `src/modules/feature_verifier.py` - Feature registry validation

### Frontend (JavaScript)
- **Framework**: None (vanilla JS)
- **Maps**: Leaflet.js
- **PWA**: Manifest.json for installability (service worker planned for future)
- **i18n**: Custom implementation (`static/js/i18n.js`)
- **Files**: 
  - `static/index.html` - Main app
  - `static/js/app.js` - App logic
  - `static/css/style.css` - Styles

### Configuration
- `config.prod.json` - Production (optimized, real events only)
- `config.dev.json` - Development (debug enabled, demo events, DEV badge)

## Critical: Auto-Generated Files ðŸš«

**DO NOT manually edit this file** - it is generated by `src/modules/builder.py`:
- `static/index.html` - Single-file HTML with everything inlined

### To modify the HTML:
1. Edit source CSS/JS files: `static/css/style.css`, `static/js/app.js`, `static/js/i18n.js`
2. Or edit templates in `src/modules/builder.py` (for advanced changes)
3. Run: `python3 src/main.py build production` (or `development`)
4. Commit both source changes AND generated `static/index.html`

## Build and Test Instructions

### Setup
```bash
# Install dependencies
pip install -r requirements.txt

# Download frontend libraries (Leaflet.js)
python3 src/main.py libs

# Verify library integrity
python3 src/main.py libs verify
```

### Running Locally
```bash
# Start local server
cd static
python3 -m http.server 8000
# Open http://localhost:8000
```

### Testing (ALWAYS run before finalizing changes)

#### Quick Development Tests
```bash
# Feature verification (validates features.json registry)
python3 verify_features.py --verbose

# Scraper tests
python3 test_scraper.py --verbose

# Filter tests
python3 test_filters.py --verbose

# Event schema validation
python3 test_event_schema.py --verbose

# KISS principle compliance
python3 check_kiss.py --verbose

# Translation tests
python3 test_translations.py --verbose

# Scheduler tests
python3 test_scheduler.py --verbose
```

#### Documentation
```bash
# Regenerate README.md (auto-generated)
python3 scripts/generate_readme.py
```

#### Linting
- **Python**: Linting is advisory (warnings don't block PRs)
- **JavaScript**: ESLint for syntax checking
- **JSON**: Strict validation (blocks PRs on errors)

See `.github/workflows/lint.yml` for full linting configuration.

### Building the Application
```bash
# Build production HTML (optimized, real events only)
python3 src/main.py build production

# Build development HTML (with demo events and DEV badge)
python3 src/main.py build development

# Fast event update (after scraping or publishing, no full rebuild)
python3 src/main.py events

# Legacy command (still works, uses builder)
python3 src/main.py generate
```

## Code Guidelines

### KISS Principle (Keep It Simple, Stupid)
This project follows **strict KISS principles**. Always:
- Minimize complexity
- Avoid over-engineering
- Use vanilla solutions over frameworks when possible
- Keep files small and focused
- Avoid unnecessary abstractions

**Enforcement**: `check_kiss.py` validates KISS compliance. Review `src/modules/kiss_checker.py` for rules.

### Python Style
- **Python 3.x** standard library preferred
- **Type hints**: Not required but appreciated
- **Docstrings**: Use for modules and complex functions
- **Error handling**: Comprehensive try/except blocks
- **Module structure**: Keep modules under 1000 lines

### JavaScript Style
- **ES6+** features are okay (async/await, arrow functions, etc.)
- **No frameworks**: Vanilla JS only (Leaflet.js is the only external library)
- **Progressive Enhancement**: App must work without JavaScript for basic content
- **Mobile First**: Always test on mobile viewport sizes

### CSS Style
- **Mobile First**: Write for mobile, enhance for desktop
- **CSS Variables**: Use for theming (see `static/css/style.css`)
- **Responsive**: Use media queries, flexbox, grid
- **Accessibility**: Ensure sufficient contrast, focus indicators

## Feature Registry System

All features must be documented in `features.json` with:
- Unique ID
- Name and description
- Category: `backend`, `frontend`, or `infrastructure`
- Implementation files
- Config keys (if applicable)
- Test method

**Validation**: Run `python3 verify_features.py` to ensure registry matches codebase.

When adding features:
1. Implement the feature
2. Add entry to `features.json`
3. Run `python3 verify_features.py --verbose` to validate

## Testing Requirements

### For Backend Changes
- Add/update tests in `test_*.py` files
- Run relevant test suite before committing
- Ensure tests pass in CI/CD

### For Frontend Changes
- Test in Chrome, Firefox, Safari
- Test on mobile devices (or Chrome DevTools mobile emulation)
- Verify PWA functionality (installability, offline mode)
- Check accessibility (keyboard navigation, screen readers)

### For Configuration Changes
- Test with both `config.dev.json` and `config.prod.json`
- Validate JSON syntax
- Run full test suite

## Deployment Workflow

Simplified workflow with two modes:

1. **Feature branch** â†’ PR to `main` branch
2. **Main branch** â†’ Auto-deploys to production (uses `config.prod.json`)

GitHub Pages serves the `static/` directory directly.

### Build Modes:
- **Production**: Real events only, optimized
- **Development**: Real + demo events, DEV badge shown

## Documentation Standards

### README.md
**AUTO-GENERATED** by `scripts/generate_readme.py`. Do not edit directly.
- Run `python3 scripts/generate_readme.py` to regenerate

### Code Documentation
- Python modules: Docstring at top of file
- Complex functions: Docstring explaining purpose, args, returns
- Configuration: Comments in JSON files (where parser allows)

### Markdown Files
- Use ATX-style headers (`#`, `##`, etc.)
- Include code blocks with language specifiers
- Add examples where helpful
- Keep lines under 120 characters when possible

## Workflow-Specific Guidelines

### Event Scraping
1. Configure source in `config.json` under `scraping.sources[]`
2. Implement scraper logic in `src/modules/scraper.py` if needed
3. Test with: `python3 test_scraper.py --verbose`
4. Scraped events go to `static/pending_events.json` for editorial review

### Editorial Workflow
1. Pending events require approval (unless `editor.auto_publish: true`)
2. Use TUI: `python3 src/main.py` â†’ "Review Pending Events"
3. Or use GitHub UI: Actions â†’ "Review Events (GitHub UI)" â†’ Run workflow
4. Actions: approve (a), edit (e), reject (r)
5. Approved events â†’ `static/events.json` â†’ appear on map
6. Approved events backed up to `backups/events/`

### Static Generation
1. HTML is generated by `src/modules/builder.py`
2. Generate: `python3 src/main.py build production` (or `development`)
3. Fast event update: `python3 src/main.py events` (no full rebuild)
4. Output: `static/index.html` (single-file HTML with everything inlined)
5. Data files live directly in `static/` (events.json, config files, etc.)

## Security Considerations

- **No secrets in code**: Use environment variables or config files (gitignored)
- **Input validation**: Always sanitize user input and scraped data
- **XSS protection**: Escape HTML when displaying user-generated content
- **HTTPS**: Production must use HTTPS (enforced by GitHub Pages)

## Common Tasks

### Add a new event source
1. Edit `config.prod.json` (production) or `config.dev.json` (development) in root directory
2. Add to `scraping.sources[]` array
3. Specify `type` (rss, html, api) and `url`
4. Test: `python3 src/main.py scrape`

### Build the application
1. For production: `python3 src/main.py build production`
2. For development: `python3 src/main.py build development`
3. Fast event update: `python3 src/main.py events`

### Add a new filter
1. Edit `static/js/app.js` (filter logic)
2. Edit `static/css/style.css` (filter UI styles)
3. Rebuild: `python3 src/main.py build production`
4. Test: `python3 test_filters.py --verbose`

### Add a new translation
1. Edit `static/content.json` (English)
2. Edit `static/content.de.json` (German)
3. Use in code: `i18n.t('key.path')`
4. Test: `python3 test_translations.py --verbose`

### Update documentation
1. Run: `python3 scripts/generate_readme.py` to regenerate README.md
2. Commit generated `README.md`

## Accessibility (A11y)

- **WCAG 2.1 Level AA** compliance required
- **Keyboard navigation**: All interactive elements must be keyboard accessible
- **ARIA labels**: Use for dynamic content and complex widgets
- **Color contrast**: Minimum 4.5:1 for normal text, 3:1 for large text
- **Focus indicators**: Visible focus styles required
- **Screen readers**: Test with NVDA (Windows) or VoiceOver (Mac/iOS)

## Performance

- **Page load**: Target < 3 seconds
- **Time to Interactive**: Target < 5 seconds
- **First Contentful Paint**: Target < 1.5 seconds
- **JavaScript bundle**: Keep minimal (vanilla JS helps)
- **Images**: Optimize, use SVG where possible
- **Caching**: Production uses aggressive caching via `config.prod.json`

## Git Workflow

### Commit Messages
- Use conventional commits: `feat:`, `fix:`, `docs:`, `test:`, `refactor:`, etc.
- Keep first line under 72 characters
- Add body for complex changes

### Branch Naming
- Feature: `feature/description`
- Fix: `fix/description`
- Copilot: `copilot/description` (auto-generated by Copilot)

### Pull Requests
- Target `main` branch
- Provide clear description
- Link related issues
- Ensure CI passes

## Questions or Issues?

- Check `README.md` for comprehensive guide
- Check `features.json` for feature registry documentation
- Run CLI commands with `--help` for detailed usage information

## Remember

1. **Test before committing** - Run relevant test suite
2. **Don't edit auto-generated files** - Edit source CSS/JS files instead
3. **Follow KISS principles** - Keep it simple
4. **Document features** - Update `features.json`
5. **Validate schemas** - Run `python3 test_event_schema.py`
6. **Check accessibility** - Test keyboard navigation and screen readers

## CLI Commands Reference

All commands are run through `src/main.py`:

### Build Commands
- `python3 src/main.py build production` - Build HTML (production mode)
- `python3 src/main.py build development` - Build HTML (development mode with demo events)
- `python3 src/main.py events` - Fast event update (no full rebuild)
- `python3 src/main.py libs` - Download CDN libraries
- `python3 src/main.py libs verify` - Verify libraries are installed

### Event Management
- `python3 src/main.py scrape` - Scrape events from sources
- `python3 src/main.py list` - List published events
- `python3 src/main.py list-pending` - List pending events
- `python3 src/main.py publish EVENT_ID` - Approve a pending event
- `python3 src/main.py reject EVENT_ID` - Reject a pending event
- `python3 src/main.py bulk-publish "pending_*"` - Bulk approve (supports wildcards)
- `python3 src/main.py bulk-reject "pending_*"` - Bulk reject (supports wildcards)

### Utility
- `python3 src/main.py` - Interactive TUI
- `python3 src/main.py --help` - Show all commands
- `python3 src/main.py generate` - Legacy command (uses builder)
