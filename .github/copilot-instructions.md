# Copilot Instructions for KRWL HOF Community Events

## Project Overview

KRWL HOF is a **mobile-first Progressive Web App (PWA)** for discovering community events with interactive map visualization. The project uses a Python backend for event scraping/management and a vanilla JavaScript frontend with Leaflet.js for mapping.

### Architecture
- **Backend**: Python 3.x with modular TUI (Text User Interface)
- **Frontend**: Vanilla JavaScript (no frameworks), Leaflet.js for maps
- **Deployment**: Static site generation â†’ GitHub Pages
- **Data Flow**: Scraping â†’ Pending queue â†’ Editorial review â†’ Published events

## Technology Stack

### Backend (Python)
- **Core**: Python 3.x, modular design
- **Dependencies**: requests>=2.31.0, beautifulsoup4>=4.12.0, lxml>=4.9.0, feedparser>=6.0.10 (see `requirements.txt`)
- **Key Modules**:
  - `src/main.py` - TUI entry point
  - `src/modules/scraper.py` - Event scraping (RSS, HTML, API)
  - `src/modules/editor.py` - Editorial workflow
  - `src/modules/generator.py` - Static site generation
  - `src/modules/filter_tester.py` - Filter testing
  - `src/modules/feature_verifier.py` - Feature registry validation
  - `src/modules/scheduler.py` - Event scheduling logic
  - `src/modules/workflow_launcher.py` - Workflow management
  - `src/modules/config_editor.py` - Configuration editing
  - `src/modules/kiss_checker.py` - KISS principle validation
  - `src/modules/utils.py` - Utility functions

### Frontend (JavaScript)
- **Framework**: None (vanilla JS)
- **Maps**: Leaflet.js
- **PWA**: Service worker, manifest.json
- **i18n**: Custom implementation (`static/js/i18n.js`)
- **Files**: 
  - `static/index.html` - Main app
  - `static/js/app.js` - App logic
  - `static/css/style.css` - Styles

### Configuration
- `config.prod.json` - Production (optimized, real events only)
- `config.dev.json` - Development (debug enabled, demo events)
- `config.preview.json` - Preview environment (shared testing)
- `static/config.json` - Runtime configuration (copied from prod/dev/preview during deployment)

## Critical: Auto-Generated Files ðŸš«

**DO NOT manually edit these files** - they are generated by `src/modules/generator.py`:
- `static/index.html`
- `static/js/app.js`
- `static/css/style.css`

These files have AUTO-GENERATED comments at the top. See `static/.copilot-protected` and `static/DO_NOT_EDIT_README.txt` for details.

### To modify these files:
1. Edit templates in `src/modules/generator.py`
2. Run: `python3 src/main.py generate`
3. Commit both template changes AND generated files

## Build and Test Instructions

### Setup
```bash
# Install dependencies
pip install -r requirements.txt

# Download frontend libraries (Leaflet.js)
./download-libs.sh

# Verify library integrity
python3 manage_libs.py verify
```

### Running Locally
```bash
# Start local server
cd static
python3 -m http.server 8000
# Open http://localhost:8000
```

### Testing (ALWAYS run before finalizing changes)

#### Quick Development Tests
```bash
# Feature verification (validates features.json registry)
python3 verify_features.py --verbose

# Scraper tests
python3 test_scraper.py --verbose

# Filter tests
python3 test_filters.py --verbose

# Event schema validation
python3 test_event_schema.py --verbose

# KISS principle compliance
python3 check_kiss.py --verbose

# Translation tests
python3 test_translations.py --verbose

# Scheduler tests
python3 test_scheduler.py --verbose
```

#### Documentation
```bash
# Validate and regenerate README.md (auto-generated from docs/)
python3 docs/build_docs.py --validate
python3 docs/build_docs.py  # Regenerates README.md
```

#### Linting
- **Python**: Linting is advisory (warnings don't block PRs)
- **JavaScript**: ESLint for syntax checking
- **JSON**: Strict validation (blocks PRs on errors)

See `.github/workflows/lint.yml` for full linting configuration.

### Generating Static Site
```bash
# Generate static files from templates
python3 src/main.py generate

# Or use TUI
python3 src/main.py  # Then select "Generate Static Site"
```

## Code Guidelines

### KISS Principle (Keep It Simple, Stupid)
This project follows **strict KISS principles**. Always:
- Minimize complexity
- Avoid over-engineering
- Use vanilla solutions over frameworks when possible
- Keep files small and focused
- Avoid unnecessary abstractions

**Enforcement**: `check_kiss.py` validates KISS compliance. Review `src/modules/kiss_checker.py` for rules.

### Python Style
- **Python 3.x** standard library preferred
- **Type hints**: Not required but appreciated
- **Docstrings**: Use for modules and complex functions
- **Error handling**: Comprehensive try/except blocks
- **Module structure**: Keep modules under 1000 lines

### JavaScript Style
- **ES6+** features are okay (async/await, arrow functions, etc.)
- **No frameworks**: Vanilla JS only (Leaflet.js is the only external library)
- **Progressive Enhancement**: App must work without JavaScript for basic content
- **Mobile First**: Always test on mobile viewport sizes

### CSS Style
- **Mobile First**: Write for mobile, enhance for desktop
- **CSS Variables**: Use for theming (see `static/css/style.css`)
- **Responsive**: Use media queries, flexbox, grid
- **Accessibility**: Ensure sufficient contrast, focus indicators

## Feature Registry System

All features must be documented in `features.json` with:
- Unique ID
- Name and description
- Category: `backend`, `frontend`, or `infrastructure`
- Implementation files
- Config keys (if applicable)
- Test method

**Validation**: Run `python3 verify_features.py` to ensure registry matches codebase.

When adding features:
1. Implement the feature
2. Add entry to `features.json`
3. Run `python3 verify_features.py --verbose` to validate

## Testing Requirements

### For Backend Changes
- Add/update tests in `test_*.py` files
- Run relevant test suite before committing
- Ensure tests pass in CI/CD

### For Frontend Changes
- Test in Chrome, Firefox, Safari
- Test on mobile devices (or Chrome DevTools mobile emulation)
- Verify PWA functionality (installability, offline mode)
- Check accessibility (keyboard navigation, screen readers)

### For Configuration Changes
- Test with both `config.dev.json` and `config.prod.json`
- Validate JSON syntax
- Run full test suite

## Deployment Workflow

1. **Feature branch** â†’ PR to `preview` branch
2. **Preview branch** â†’ Auto-deploys to `/preview/` path (uses `config.dev.json`)
3. **Test preview thoroughly**
4. **Promote to main** â†’ Manually run "Promote Preview" workflow (creates PR to `main`)
5. **Main branch** â†’ Auto-deploys to production (uses `config.prod.json`)

The "Promote Preview" workflow is **manually triggered** via GitHub Actions workflow_dispatch.

See `.github/DEPLOYMENT.md` and `.github/PROMOTE_WORKFLOW.md` for details.

## Documentation Standards

### README.md
**AUTO-GENERATED** by `docs/build_docs.py`. Do not edit directly.
- Edit source files in `docs/` directory
- Run `python3 docs/build_docs.py` to regenerate

### Code Documentation
- Python modules: Docstring at top of file
- Complex functions: Docstring explaining purpose, args, returns
- Configuration: Comments in JSON files (where parser allows)

### Markdown Files
- Use ATX-style headers (`#`, `##`, etc.)
- Include code blocks with language specifiers
- Add examples where helpful
- Keep lines under 120 characters when possible

## Workflow-Specific Guidelines

### Event Scraping
1. Configure source in `config.json` under `scraping.sources[]`
2. Implement scraper logic in `src/modules/scraper.py` if needed
3. Test with: `python3 test_scraper.py --verbose`
4. Scraped events go to `data/pending_events.json` for editorial review

### Editorial Workflow
1. Pending events require approval (unless `editor.auto_publish: true`)
2. Use TUI: `python3 src/main.py` â†’ "Review Pending Events"
3. Actions: approve (a), edit (e), reject (r)
4. Approved events â†’ `data/events.json` â†’ appear on map

### Static Generation
1. Templates in `src/modules/generator.py`
2. Generate: `python3 src/main.py generate`
3. Output: `static/` directory
4. Built-in protection detects manual changes before overwriting

## Security Considerations

- **No secrets in code**: Use environment variables or config files (gitignored)
- **Input validation**: Always sanitize user input and scraped data
- **XSS protection**: Escape HTML when displaying user-generated content
- **HTTPS**: Production must use HTTPS (enforced by GitHub Pages)

## Common Tasks

### Add a new event source
1. Edit `config.prod.json` (production) or `config.dev.json` (development) in root directory
2. **Note**: `static/config.json` is auto-generated during deployment - DO NOT edit directly
3. Add to `scraping.sources[]` array
4. Specify `type` (rss, html, api) and `url`
5. Test: `python3 src/main.py` â†’ "Scrape Events"

### Add a new filter
1. Edit `src/modules/generator.py` (filter logic in template)
2. Add filter UI in template
3. Regenerate: `python3 src/main.py generate`
4. Test: `python3 test_filters.py --verbose`

### Add a new translation
1. Edit `static/content.json` (English)
2. Edit `static/content.de.json` (German)
3. Use in code: `i18n.t('key.path')`
4. Test: `python3 test_translations.py --verbose`

### Update documentation
1. Edit files in `docs/` directory
2. Run: `python3 docs/build_docs.py`
3. Commit both source files and generated `README.md`

## Accessibility (A11y)

- **WCAG 2.1 Level AA** compliance required
- **Keyboard navigation**: All interactive elements must be keyboard accessible
- **ARIA labels**: Use for dynamic content and complex widgets
- **Color contrast**: Minimum 4.5:1 for normal text, 3:1 for large text
- **Focus indicators**: Visible focus styles required
- **Screen readers**: Test with NVDA (Windows) or VoiceOver (Mac/iOS)

## Performance

- **Page load**: Target < 3 seconds
- **Time to Interactive**: Target < 5 seconds
- **First Contentful Paint**: Target < 1.5 seconds
- **JavaScript bundle**: Keep minimal (vanilla JS helps)
- **Images**: Optimize, use SVG where possible
- **Caching**: Production uses aggressive caching via `config.prod.json`

## Git Workflow

### Commit Messages
- Use conventional commits: `feat:`, `fix:`, `docs:`, `test:`, `refactor:`, etc.
- Keep first line under 72 characters
- Add body for complex changes

### Branch Naming
- Feature: `feature/description`
- Fix: `fix/description`
- Copilot: `copilot/description` (auto-generated by Copilot)

### Pull Requests
- Target `preview` branch (not `main`)
- Provide clear description
- Link related issues
- Ensure CI passes
- Test the preview deployment before promoting

## Questions or Issues?

- Check `docs/TESTING.md` for comprehensive testing guide
- Check `.github/DEPLOYMENT.md` for deployment details
- Check `docs/FEATURE_REGISTRY.md` for feature registry documentation
- Check `docs/SCRAPING.md` for event scraping guide
- Check `docs/LOCALIZATION.md` for i18n details

## Remember

1. **Test before committing** - Run relevant test suite
2. **Don't edit auto-generated files** - Edit templates instead
3. **Follow KISS principles** - Keep it simple
4. **Document features** - Update `features.json`
5. **Preview before production** - Use preview branch workflow
6. **Validate schemas** - Run `python3 test_event_schema.py`
7. **Check accessibility** - Test keyboard navigation and screen readers
