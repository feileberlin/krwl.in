# Deployment Issue Fix - PR #343 Not Deploying

## Problem Statement

Changes merged to main branch (specifically PR #343) were not being deployed to the live site. Users reported seeing old content even after successful PR merges.

## Root Cause Analysis

### Issue Discovery

1. **PR #343 merged successfully** to main (commit `9a8c6ea`)
2. **No workflow run triggered** for this commit
3. **Most recent workflow run** was for PR #342 (commit `d111e17`)

### Root Cause

The GitHub Actions workflow `website-maintenance.yml` had **path filters on the push trigger**:

```yaml
push:
  branches:
    - main
  paths:
    - 'assets/**'      # Any asset changes (CSS, JS, HTML, JSON, SVG)
    - 'src/**'         # Any source code changes (Python modules, tools)
    - 'config.json'    # Configuration changes
```

**Problem:** When a PR is merged that:
- Contains no file changes (verification/doc-only PRs)
- Changes files outside the filtered paths
- Is a merge commit with empty diff

...the workflow **does NOT trigger at all**, resulting in no deployment.

### Why This Matters

- **Silent failures**: Changes reach main but never deploy
- **Inconsistent deployments**: Some PRs deploy, others don't
- **User confusion**: Site appears broken or outdated
- **Lost updates**: Features/fixes merged but never go live

## Solution Implemented

### Changes Made

#### 1. Remove Path Filter from Push Trigger

**Before:**
```yaml
push:
  branches:
    - main
  paths:
    - 'assets/**'
    - 'src/**'
    - 'config.json'
```

**After:**
```yaml
push:
  branches:
    - main
  # Note: No paths filter here - ALL pushes to main should trigger deployment
  # Path-based optimizations are handled within individual jobs
```

#### 2. Simplify Full Rebuild Job Condition

**Before:**
```yaml
if: |
  always() &&
  (github.event.inputs.task == 'force-deploy' ||
   github.event.inputs.task == 'scrape-and-deploy' ||
   (github.event_name == 'push' && 
    (contains(github.event.head_commit.modified, 'config.json') ||
     contains(github.event.head_commit.modified, 'src/modules/scraper.py'))))
```

**After:**
```yaml
if: |
  always() &&
  (github.event.inputs.task == 'force-deploy' ||
   github.event.inputs.task == 'scrape-and-deploy' ||
   github.event_name == 'push')
```

### Why This Works

1. **All pushes to main now trigger workflow** - No more silent skips
2. **Full rebuild runs for every push** - Ensures site is always up-to-date
3. **Deployment still has guards** - Only deploys when artifacts are uploaded
4. **Path-based optimizations preserved** - Other jobs still have path checks where appropriate

### Performance Considerations

**Q: Won't this waste CI minutes?**

**A: No, because:**
- GitHub Pages artifacts are cached and reused when possible
- The build process is already fast (~2-3 minutes)
- Deployment only runs when artifacts are uploaded
- The benefit of reliable deployments outweighs minimal CI cost

**Q: What about unnecessary rebuilds?**

**A: Acceptable tradeoff:**
- Ensures consistency and reliability
- GitHub Actions has generous free tier (2000 minutes/month for private repos, unlimited for public)
- This is a static site with fast build times
- Alternative approaches (complex path logic) are error-prone and hard to maintain

## Expected Behavior After Fix

### Before Fix
```
PR #343 merged → No workflow trigger → No deployment → Site unchanged ❌
```

### After Fix
```
PR #343 merged → Workflow triggers → Full rebuild → Artifact uploaded → Deployment succeeds → Site updated ✅
```

### All Future Merges
- **Every push to main** triggers workflow
- **Full rebuild job** always runs
- **Deployment job** runs when artifact is uploaded
- **Site stays in sync** with main branch

## Verification Steps

1. ✅ Workflow syntax validated
2. ✅ Changes committed to fix branch
3. ⏳ PR review and merge
4. ⏳ Monitor workflow run after merge
5. ⏳ Verify deployment succeeds
6. ⏳ Confirm changes visible on live site

## Additional Recommendations

### For Future Workflow Changes

1. **Avoid path filters at trigger level** - Use job-level conditions instead
2. **Test workflow triggers** - Ensure all merge scenarios trigger deployment
3. **Monitor workflow runs** - Check that deployments complete successfully
4. **Document trigger logic** - Make it clear when workflows run

### For Site Maintainers

1. **Force rebuild if needed** - Use workflow_dispatch with `force-deploy` task
2. **Check workflow runs** - Verify deployment after merging important PRs
3. **Review deployment logs** - Ensure artifacts are uploaded correctly

## Related Files

- `.github/workflows/website-maintenance.yml` - Modified workflow file
- `public/index.html` - Generated by workflow (gitignored)
- `config.json` - Site configuration

## Testing

Once merged, this fix can be tested by:
1. Merging any PR to main (even documentation-only)
2. Verifying workflow triggers automatically
3. Confirming deployment completes successfully
4. Checking that site updates appear live

## Success Criteria

- ✅ All merges to main trigger workflow
- ✅ Full rebuild runs for all push events
- ✅ Artifacts uploaded successfully
- ✅ Deployment completes without errors
- ✅ Site reflects latest main branch content

---

**Issue:** feileberlin/krwl-hof#343  
**Fixed By:** @copilot  
**Date:** 2026-01-25
